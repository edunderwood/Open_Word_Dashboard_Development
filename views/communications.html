<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Communications - Open Word Admin</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .recipient-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 16px;
    }
    .recipient-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #f3f4f6;
      gap: 12px;
    }
    .recipient-item:last-child {
      border-bottom: none;
    }
    .recipient-item:hover {
      background: #f9fafb;
    }
    .recipient-item.opted-out {
      opacity: 0.5;
      background: #fef2f2;
    }
    .recipient-item.paused {
      background: #fffbeb;
    }
    .recipient-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .recipient-info {
      flex: 1;
    }
    .recipient-name {
      font-weight: 500;
      color: #374151;
    }
    .recipient-email {
      font-size: 12px;
      color: #6b7280;
    }
    .recipient-badges {
      display: flex;
      gap: 6px;
    }
    .select-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: center;
    }
    .select-count {
      font-size: 14px;
      color: #6b7280;
    }
    .email-composer {
      display: grid;
      gap: 16px;
    }
    .email-composer label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }
    .email-composer textarea {
      width: 100%;
      min-height: 200px;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }
    .email-composer textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .template-select {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .template-btn {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    .template-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }
    .template-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    .sender-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: #f3f4f6;
      border-radius: 6px;
      font-size: 14px;
      color: #4b5563;
    }
    .sender-info svg {
      width: 20px;
      height: 20px;
      color: #667eea;
    }
    .send-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    .history-table {
      width: 100%;
    }
    .history-table th, .history-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    .history-table th {
      background: #f9fafb;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: #6b7280;
    }
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .tab-btn {
      padding: 12px 20px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.2s;
    }
    .tab-btn:hover {
      color: #374151;
    }
    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .preview-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .preview-modal.active {
      display: flex;
    }
    .preview-content {
      background: white;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    }
    .preview-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .preview-header h3 {
      margin: 0;
      font-size: 18px;
    }
    .preview-body {
      padding: 20px;
    }
    .preview-footer {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .email-preview-frame {
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 20px;
      background: #f9fafb;
    }
    .filter-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>Open Word</h1>
        <p>Admin Dashboard</p>
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li>
            <a href="/dashboard">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
              </svg>
              Dashboard
            </a>
          </li>
          <li>
            <a href="/customers">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
              Customers
            </a>
          </li>
          <li>
            <a href="/pricing">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Pricing
            </a>
          </li>
          <li>
            <a href="/costs">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Costs
            </a>
          </li>
          <li>
            <a href="/charity-registers">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              Charity Registers
            </a>
          </li>
          <li>
            <a href="/communications" class="active">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              Communications
            </a>
          </li>
          <li>
            <a href="/monitoring">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              Monitoring
            </a>
          </li>
          <li>
            <a href="/analytics">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
              </svg>
              Analytics
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar-footer">
        <button onclick="logout()">Sign Out</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h2>Customer Communications</h2>
        <p>Send emails to customers about updates, maintenance, and announcements</p>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('compose')">Compose Email</button>
        <button class="tab-btn" onclick="switchTab('history')">Send History</button>
      </div>

      <!-- Compose Tab -->
      <div id="compose-tab" class="tab-content active">
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 24px;">
          <!-- Recipients Panel -->
          <div class="card">
            <h3 style="margin-top: 0;">Recipients</h3>

            <div class="filter-row">
              <select id="tierFilter" class="form-input" style="width: auto;" onchange="filterRecipients()">
                <option value="">All Tiers</option>
                <option value="basic">Basic</option>
                <option value="standard">Standard</option>
                <option value="pro">Pro</option>
                <option value="enterprise">Enterprise</option>
              </select>
              <select id="statusFilter" class="form-input" style="width: auto;" onchange="filterRecipients()">
                <option value="">All Statuses</option>
                <option value="active">Active Only</option>
                <option value="paused">Paused</option>
              </select>
            </div>

            <div class="select-controls">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="recipient-checkbox">
                <span>Select All</span>
              </label>
              <span class="select-count" id="selectCount">0 of 0 selected</span>
            </div>

            <div class="recipient-list" id="recipientList">
              <div style="padding: 20px; text-align: center; color: #6b7280;">Loading customers...</div>
            </div>

            <div class="alert alert-warning" style="margin-top: 12px; font-size: 13px;">
              <strong>Note:</strong> Customers who have opted out of emails will be shown but cannot be selected.
            </div>
          </div>

          <!-- Email Composer Panel -->
          <div class="card">
            <h3 style="margin-top: 0;">Email Content</h3>

            <div class="sender-info">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              <span>From: <strong>support@openword.live</strong></span>
            </div>

            <div style="margin: 16px 0;">
              <label style="font-weight: 500; margin-bottom: 8px; display: block;">Quick Templates:</label>
              <div class="template-select" id="templateButtons">
                <!-- Templates loaded via JS -->
              </div>
            </div>

            <div class="email-composer">
              <div>
                <label for="emailSubject">Subject</label>
                <input type="text" id="emailSubject" class="form-input" placeholder="Enter email subject...">
              </div>

              <div>
                <label for="emailBody">Message</label>
                <textarea id="emailBody" placeholder="Enter your message here..."></textarea>
              </div>
            </div>

            <div class="send-actions">
              <button class="btn btn-secondary" onclick="previewEmail()">Preview</button>
              <button class="btn btn-primary" onclick="sendBulkEmail()" id="sendBtn" disabled>
                Send to <span id="sendCount">0</span> Recipients
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- History Tab -->
      <div id="history-tab" class="tab-content">
        <div class="card">
          <h3 style="margin-top: 0;">Email Send History</h3>
          <div class="table-container">
            <table class="history-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Recipient</th>
                  <th>Subject</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Sent By</th>
                </tr>
              </thead>
              <tbody id="historyTable">
                <tr><td colspan="6" style="text-align: center; color: #6b7280;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
          <div style="margin-top: 16px; display: flex; justify-content: center; gap: 8px;">
            <button class="btn btn-secondary btn-sm" onclick="loadHistory(historyOffset - 50)" id="prevHistoryBtn" disabled>Previous</button>
            <button class="btn btn-secondary btn-sm" onclick="loadHistory(historyOffset + 50)" id="nextHistoryBtn">Next</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Preview Modal -->
  <div class="preview-modal" id="previewModal">
    <div class="preview-content">
      <div class="preview-header">
        <h3>Email Preview</h3>
        <button onclick="closePreview()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
      </div>
      <div class="preview-body">
        <p><strong>To:</strong> <span id="previewTo"></span></p>
        <p><strong>Subject:</strong> <span id="previewSubject"></span></p>
        <hr style="margin: 16px 0; border: none; border-top: 1px solid #e5e7eb;">
        <div class="email-preview-frame" id="previewBody"></div>
      </div>
      <div class="preview-footer">
        <button class="btn btn-secondary" onclick="closePreview()">Close</button>
        <button class="btn btn-primary" onclick="closePreview(); sendBulkEmail();">Send Email</button>
      </div>
    </div>
  </div>

  <script>
    let allCustomers = [];
    let filteredCustomers = [];
    let templates = [];
    let historyOffset = 0;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadCustomers();
      loadTemplates();
    });

    // Load customers with emails
    async function loadCustomers() {
      try {
        const response = await fetch('/api/communications/customers');
        const data = await response.json();

        if (data.success) {
          allCustomers = data.customers;
          filteredCustomers = [...allCustomers];
          renderRecipients();
        } else {
          console.error('Failed to load customers:', data.error);
        }
      } catch (error) {
        console.error('Error loading customers:', error);
      }
    }

    // Load templates
    async function loadTemplates() {
      try {
        const response = await fetch('/api/communications/templates');
        const data = await response.json();

        if (data.success) {
          templates = data.templates;
          renderTemplates();
        }
      } catch (error) {
        console.error('Error loading templates:', error);
      }
    }

    // Render template buttons
    function renderTemplates() {
      const container = document.getElementById('templateButtons');
      container.innerHTML = templates.map(t => `
        <button class="template-btn" onclick="selectTemplate('${t.id}')" data-template="${t.id}">
          ${t.name}
        </button>
      `).join('');
    }

    // Select a template
    function selectTemplate(templateId) {
      const template = templates.find(t => t.id === templateId);
      if (!template) return;

      document.getElementById('emailSubject').value = template.subject;
      document.getElementById('emailBody').value = template.body;

      // Update active state
      document.querySelectorAll('.template-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.template === templateId);
      });
    }

    // Render recipients list
    function renderRecipients() {
      const container = document.getElementById('recipientList');

      if (filteredCustomers.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280;">No customers found</div>';
        updateSelectCount();
        return;
      }

      container.innerHTML = filteredCustomers.map(c => {
        const classes = ['recipient-item'];
        if (c.emailOptOut) classes.push('opted-out');
        if (c.isPaused) classes.push('paused');

        return `
          <div class="${classes.join(' ')}" data-id="${c.id}">
            <input
              type="checkbox"
              class="recipient-checkbox"
              data-id="${c.id}"
              ${c.emailOptOut ? 'disabled' : ''}
              onchange="updateSelectCount()"
            >
            <div class="recipient-info">
              <div class="recipient-name">${escapeHtml(c.name)}</div>
              <div class="recipient-email">${escapeHtml(c.email)}</div>
            </div>
            <div class="recipient-badges">
              <span class="badge badge-${getTierBadgeClass(c.tier)}">${c.tier}</span>
              ${c.isPaused ? '<span class="badge badge-warning">Paused</span>' : ''}
              ${c.emailOptOut ? '<span class="badge badge-danger">Opted Out</span>' : ''}
            </div>
          </div>
        `;
      }).join('');

      updateSelectCount();
    }

    // Get badge class for tier
    function getTierBadgeClass(tier) {
      const classes = {
        basic: 'gray',
        standard: 'info',
        pro: 'success',
        enterprise: 'primary',
        trial: 'warning'
      };
      return classes[tier] || 'gray';
    }

    // Filter recipients
    function filterRecipients() {
      const tierFilter = document.getElementById('tierFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;

      filteredCustomers = allCustomers.filter(c => {
        if (tierFilter && c.tier !== tierFilter) return false;
        if (statusFilter === 'active' && c.isPaused) return false;
        if (statusFilter === 'paused' && !c.isPaused) return false;
        return true;
      });

      renderRecipients();
    }

    // Toggle select all
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll').checked;
      document.querySelectorAll('.recipient-checkbox:not([disabled])').forEach(cb => {
        if (cb.id !== 'selectAll') {
          cb.checked = selectAll;
        }
      });
      updateSelectCount();
    }

    // Update selection count
    function updateSelectCount() {
      const checkboxes = document.querySelectorAll('.recipient-checkbox[data-id]');
      const checked = document.querySelectorAll('.recipient-checkbox[data-id]:checked');
      const total = document.querySelectorAll('.recipient-checkbox[data-id]:not([disabled])').length;

      document.getElementById('selectCount').textContent = `${checked.length} of ${total} selected`;
      document.getElementById('sendCount').textContent = checked.length;
      document.getElementById('sendBtn').disabled = checked.length === 0;

      // Update select all checkbox
      const selectAllCheckbox = document.getElementById('selectAll');
      selectAllCheckbox.checked = checked.length === total && total > 0;
      selectAllCheckbox.indeterminate = checked.length > 0 && checked.length < total;
    }

    // Get selected customer IDs
    function getSelectedIds() {
      return Array.from(document.querySelectorAll('.recipient-checkbox[data-id]:checked'))
        .map(cb => cb.dataset.id);
    }

    // Preview email
    function previewEmail() {
      const subject = document.getElementById('emailSubject').value.trim();
      const body = document.getElementById('emailBody').value.trim();
      const selectedIds = getSelectedIds();

      if (!subject) {
        alert('Please enter a subject');
        return;
      }
      if (!body) {
        alert('Please enter a message');
        return;
      }
      if (selectedIds.length === 0) {
        alert('Please select at least one recipient');
        return;
      }

      // Get selected customer emails for preview
      const selectedCustomers = filteredCustomers.filter(c => selectedIds.includes(c.id));
      const emailList = selectedCustomers.slice(0, 3).map(c => c.email).join(', ');
      const moreCount = selectedCustomers.length - 3;

      document.getElementById('previewTo').textContent = emailList + (moreCount > 0 ? ` and ${moreCount} more` : '');
      document.getElementById('previewSubject').textContent = subject;
      document.getElementById('previewBody').innerHTML = '<p>' + escapeHtml(body).replace(/\n/g, '<br>') + '</p>';

      document.getElementById('previewModal').classList.add('active');
    }

    // Close preview
    function closePreview() {
      document.getElementById('previewModal').classList.remove('active');
    }

    // Send bulk email
    async function sendBulkEmail() {
      const subject = document.getElementById('emailSubject').value.trim();
      const body = document.getElementById('emailBody').value.trim();
      const selectedIds = getSelectedIds();

      if (!subject || !body || selectedIds.length === 0) {
        alert('Please fill in all fields and select recipients');
        return;
      }

      if (!confirm(`Send email to ${selectedIds.length} recipient(s)?`)) {
        return;
      }

      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      try {
        const response = await fetch('/api/communications/send-bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customerIds: selectedIds,
            subject: subject,
            body: body,
            emailType: 'bulk_announcement'
          })
        });

        const data = await response.json();

        if (data.success) {
          alert(`Email sent successfully!\n\nSent: ${data.sent}\nFailed: ${data.failed}`);

          // Clear form
          document.getElementById('emailSubject').value = '';
          document.getElementById('emailBody').value = '';
          document.querySelectorAll('.recipient-checkbox:checked').forEach(cb => cb.checked = false);
          document.querySelectorAll('.template-btn.active').forEach(btn => btn.classList.remove('active'));
          updateSelectCount();
        } else {
          alert('Failed to send email: ' + data.error);
        }
      } catch (error) {
        console.error('Error sending email:', error);
        alert('Error sending email: ' + error.message);
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = 'Send to <span id="sendCount">0</span> Recipients';
        updateSelectCount();
      }
    }

    // Switch tabs
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(tab));
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `${tab}-tab`);
      });

      if (tab === 'history') {
        loadHistory(0);
      }
    }

    // Load email history
    async function loadHistory(offset = 0) {
      historyOffset = Math.max(0, offset);

      try {
        const response = await fetch(`/api/communications/history?limit=50&offset=${historyOffset}`);
        const data = await response.json();

        if (data.success) {
          renderHistory(data.logs, data.total);
        }
      } catch (error) {
        console.error('Error loading history:', error);
      }
    }

    // Render history table
    function renderHistory(logs, total) {
      const tbody = document.getElementById('historyTable');

      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No emails sent yet</td></tr>';
        return;
      }

      tbody.innerHTML = logs.map(log => `
        <tr>
          <td>${new Date(log.sent_at).toLocaleString()}</td>
          <td>
            <div style="font-weight: 500;">${escapeHtml(log.recipient_name || 'Unknown')}</div>
            <div style="font-size: 12px; color: #6b7280;">${escapeHtml(log.recipient_email)}</div>
          </td>
          <td>${escapeHtml(log.subject)}</td>
          <td><span class="badge badge-info">${log.email_type || 'custom'}</span></td>
          <td><span class="badge badge-${log.status === 'sent' ? 'success' : 'danger'}">${log.status}</span></td>
          <td>${escapeHtml(log.sent_by || 'admin')}</td>
        </tr>
      `).join('');

      // Update pagination
      document.getElementById('prevHistoryBtn').disabled = historyOffset === 0;
      document.getElementById('nextHistoryBtn').disabled = historyOffset + 50 >= total;
    }

    // Escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Logout
    function logout() {
      window.location.href = '/auth/logout';
    }

    // Close modal on overlay click
    document.getElementById('previewModal').addEventListener('click', (e) => {
      if (e.target.id === 'previewModal') {
        closePreview();
      }
    });
  </script>
</body>
</html>
