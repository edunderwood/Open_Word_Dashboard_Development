<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Details - Open Word Admin</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--primary);
      text-decoration: none;
      margin-bottom: 20px;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .detail-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .detail-card h3 {
      margin: 0 0 16px 0;
      font-size: 1rem;
      color: var(--gray-700);
      border-bottom: 1px solid var(--gray-200);
      padding-bottom: 8px;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--gray-100);
    }
    .detail-row:last-child {
      border-bottom: none;
    }
    .detail-label {
      color: var(--gray-500);
      font-size: 0.875rem;
    }
    .detail-value {
      font-weight: 500;
      color: var(--gray-900);
    }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    .badge-gray { background: #f3f4f6; color: #4b5563; }
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .discount-pending-alert {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .discount-pending-alert h4 {
      margin: 0 0 8px 0;
      color: #92400e;
    }
    .discount-pending-alert p {
      margin: 0;
      color: #78350f;
    }
    .approve-form {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #f59e0b;
    }
    .approve-form label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #78350f;
    }
    .approve-form select, .approve-form input {
      width: 100%;
      padding: 8px;
      border: 1px solid #d97706;
      border-radius: 4px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>Open Word</h1>
        <p>Admin Dashboard</p>
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li><a href="/dashboard"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>Dashboard</a></li>
          <li><a href="/customers" class="active"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>Customers</a></li>
          <li><a href="/pricing"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Pricing</a></li>
          <li><a href="/costs"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>Costs</a></li>
          <li><a href="/monitoring"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>Monitoring</a></li>
          <li><a href="/analytics"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" /></svg>Analytics</a></li>
        </ul>
      </nav>
      <div class="sidebar-footer">
        <button onclick="logout()">Sign Out</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <a href="/customers" class="back-link">&larr; Back to Customers</a>

      <div class="page-header">
        <h2 id="customerName">Loading...</h2>
        <p id="customerKey" style="color: var(--gray-500);"></p>
      </div>

      <!-- Discount Review Alert -->
      <div id="discountReviewAlert" class="discount-pending-alert" style="display: none;">
        <h4>Discount Review Requested</h4>
        <p id="discountReviewReason"></p>
        <p id="discountReviewDate" style="font-size: 0.875rem; margin-top: 8px;"></p>
        <div class="approve-form">
          <label for="discountPercent">Discount Percentage</label>
          <select id="discountPercent">
            <option value="10">10%</option>
            <option value="20">20%</option>
            <option value="30">30%</option>
            <option value="40">40%</option>
            <option value="50" selected>50%</option>
          </select>
          <label for="discountType">Discount Type</label>
          <select id="discountType">
            <option value="church">Church</option>
            <option value="nonprofit">Non-profit</option>
            <option value="educational">Educational</option>
            <option value="community">Community Group</option>
            <option value="other">Other</option>
          </select>
          <div style="display: flex; gap: 8px;">
            <button class="btn" style="background: #10b981; color: white;" onclick="approveDiscount()">Approve Discount</button>
            <button class="btn btn-outline" style="color: #dc2626; border-color: #dc2626;" onclick="denyDiscount()">Deny</button>
          </div>
        </div>
      </div>

      <!-- Detail Cards -->
      <div class="detail-grid">
        <!-- Organisation Info -->
        <div class="detail-card">
          <h3>Organisation</h3>
          <div class="detail-row">
            <span class="detail-label">Name</span>
            <span class="detail-value" id="orgName">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Organisation Key</span>
            <span class="detail-value" id="orgKey">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Contact</span>
            <span class="detail-value" id="contactName">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Phone</span>
            <span class="detail-value" id="contactPhone">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Registered</span>
            <span class="detail-value" id="registeredAt">-</span>
          </div>
        </div>

        <!-- Subscription -->
        <div class="detail-card">
          <h3>Subscription</h3>
          <div class="detail-row">
            <span class="detail-label">Plan</span>
            <span class="detail-value" id="subscriptionTier">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Status</span>
            <span class="detail-value" id="subscriptionStatus">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Monthly Fee</span>
            <span class="detail-value" id="monthlyFee">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Payment Status</span>
            <span class="detail-value" id="paymentStatus">-</span>
          </div>
        </div>

        <!-- Discount/Charity Status -->
        <div class="detail-card">
          <h3>Discount Status</h3>
          <div class="detail-row">
            <span class="detail-label">Is Charity</span>
            <span class="detail-value" id="isCharity">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Charity Number</span>
            <span class="detail-value" id="charityNumber">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Charity Verified</span>
            <span class="detail-value" id="charityVerified">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Discount</span>
            <span class="detail-value" id="discountPercent">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Discount Type</span>
            <span class="detail-value" id="discountTypeDisplay">-</span>
          </div>
        </div>

        <!-- Credits -->
        <div class="detail-card">
          <h3>Credits</h3>
          <div class="detail-row">
            <span class="detail-label">Current Balance</span>
            <span class="detail-value" id="creditBalance">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Lifetime Purchased</span>
            <span class="detail-value" id="lifetimePurchased">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Lifetime Used</span>
            <span class="detail-value" id="lifetimeUsed">-</span>
          </div>
          <div class="action-buttons">
            <button class="btn btn-sm" style="background: #10b981; color: white;" onclick="showAddCreditsModal()">Add Credits</button>
          </div>
        </div>

        <!-- Activity -->
        <div class="detail-card">
          <h3>Activity</h3>
          <div class="detail-row">
            <span class="detail-label">Last Login</span>
            <span class="detail-value" id="lastLogin">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Last Streaming</span>
            <span class="detail-value" id="lastStreaming">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Total Sessions</span>
            <span class="detail-value" id="totalSessions">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Avg Session Duration</span>
            <span class="detail-value" id="avgSessionDuration">-</span>
          </div>
        </div>

        <!-- Actions -->
        <div class="detail-card">
          <h3>Actions</h3>
          <div class="action-buttons" style="flex-direction: column;">
            <button class="btn" id="pauseBtn" onclick="togglePause()">Pause Account</button>
            <button class="btn btn-outline" id="setDiscountBtn" onclick="showSetDiscountModal()">Set Discount</button>
            <button class="btn btn-outline" style="color: #dc2626; border-color: #dc2626;" id="removeDiscountBtn" onclick="removeDiscount()" style="display: none;">Remove Discount</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Get customer ID from URL
    const customerId = window.location.pathname.split('/').pop();
    let customerData = null;

    // Format date helper
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Format currency
    function formatPence(pence) {
      return new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: 'GBP'
      }).format((pence || 0) / 100);
    }

    // Load customer data
    async function loadCustomer() {
      try {
        const [customerRes, creditsRes, sessionRes] = await Promise.all([
          fetch(`/api/customers/${customerId}`),
          fetch(`/api/customers/${customerId}/credits`),
          fetch(`/api/customers/${customerId}/session-stats`)
        ]);

        const customerJson = await customerRes.json();
        const creditsJson = await creditsRes.json();
        const sessionJson = await sessionRes.json();

        if (!customerJson.success) throw new Error(customerJson.error);

        customerData = customerJson.data;
        const credits = creditsJson.data || {};
        const sessions = sessionJson.data || {};

        // Update page title
        document.getElementById('customerName').textContent = customerData.name || 'Unknown';
        document.getElementById('customerKey').textContent = customerData.organisation_key || '';
        document.title = `${customerData.name} - Open Word Admin`;

        // Organisation info
        document.getElementById('orgName').textContent = customerData.name || '-';
        document.getElementById('orgKey').textContent = customerData.organisation_key || '-';
        document.getElementById('contactName').textContent = customerData.contact_name || '-';
        document.getElementById('contactPhone').textContent = customerData.contact_phone || '-';
        document.getElementById('registeredAt').textContent = formatDate(customerData.created_at);

        // Subscription
        document.getElementById('subscriptionTier').innerHTML = `<span class="badge badge-info">${(customerData.subscription_tier || 'basic').toUpperCase()}</span>`;
        document.getElementById('subscriptionStatus').innerHTML = getStatusBadge(customerData.subscription_status || 'active');
        document.getElementById('monthlyFee').textContent = formatPence((customerData.minimum_monthly_fee || 0) * 100);
        document.getElementById('paymentStatus').innerHTML = getPaymentBadge(customerData.payment_status);

        // Discount/Charity
        document.getElementById('isCharity').textContent = customerData.is_charity ? 'Yes' : 'No';
        document.getElementById('charityNumber').textContent = customerData.charity_number || '-';
        document.getElementById('charityVerified').innerHTML = customerData.charity_verified
          ? '<span class="badge badge-success">Verified</span>'
          : '<span class="badge badge-gray">No</span>';
        document.getElementById('discountPercent').textContent = customerData.discount_percent ? `${customerData.discount_percent}%` : 'None';
        document.getElementById('discountTypeDisplay').textContent = customerData.discount_type || '-';

        // Show remove discount button if has discount
        if (customerData.discount_percent > 0) {
          document.getElementById('removeDiscountBtn').style.display = 'block';
        }

        // Credits
        const balance = credits.balance || {};
        document.getElementById('creditBalance').textContent = (balance.current || 0).toFixed(2);
        document.getElementById('lifetimePurchased').textContent = (balance.lifetimePurchased || 0).toFixed(2);
        document.getElementById('lifetimeUsed').textContent = (balance.lifetimeUsed || 0).toFixed(2);

        // Activity
        document.getElementById('lastLogin').textContent = formatDate(sessions.lastLogin);
        document.getElementById('lastStreaming').textContent = sessions.lastStreamingSession
          ? formatDate(sessions.lastStreamingSession.startedAt)
          : '-';
        document.getElementById('totalSessions').textContent = sessions.sessionStats?.totalSessions || 0;
        document.getElementById('avgSessionDuration').textContent = sessions.sessionStats?.avgSessionDurationFormatted || '-';

        // Pause button
        document.getElementById('pauseBtn').textContent = customerData.is_paused ? 'Unpause Account' : 'Pause Account';

        // Discount review alert
        if (customerData.discount_review_requested && customerData.discount_percent === 0) {
          document.getElementById('discountReviewAlert').style.display = 'block';
          document.getElementById('discountReviewReason').textContent = customerData.discount_review_reason || 'No reason provided';
          document.getElementById('discountReviewDate').textContent = `Requested: ${formatDate(customerData.discount_review_requested_at)}`;
        }

      } catch (error) {
        console.error('Error loading customer:', error);
        document.getElementById('customerName').textContent = 'Error loading customer';
      }
    }

    function getStatusBadge(status) {
      const badges = {
        active: '<span class="badge badge-success">Active</span>',
        trialing: '<span class="badge badge-info">Trial</span>',
        past_due: '<span class="badge badge-warning">Past Due</span>',
        cancelled: '<span class="badge badge-danger">Cancelled</span>',
        paused: '<span class="badge badge-warning">Paused</span>'
      };
      return badges[status] || `<span class="badge badge-gray">${status}</span>`;
    }

    function getPaymentBadge(status) {
      const badges = {
        paid: '<span class="badge badge-success">Paid</span>',
        pending: '<span class="badge badge-warning">Pending</span>',
        failed: '<span class="badge badge-danger">Failed</span>'
      };
      return badges[status] || `<span class="badge badge-gray">${status || 'Unknown'}</span>`;
    }

    // Approve discount
    async function approveDiscount() {
      const percent = document.getElementById('discountPercent').value;
      const type = document.getElementById('discountType').value;

      try {
        const res = await fetch(`/api/customers/${customerId}/set-discount`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            discountPercent: parseInt(percent),
            discountType: type,
            reason: customerData.discount_review_reason
          })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error);

        alert(`${percent}% ${type} discount approved!`);
        window.location.reload();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Deny discount
    async function denyDiscount() {
      if (!confirm('Deny this discount request?')) return;

      try {
        const res = await fetch(`/api/customers/${customerId}/deny-discount-request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: 'Not eligible for discount' })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error);

        alert('Discount request denied');
        window.location.reload();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Toggle pause
    async function togglePause() {
      const action = customerData.is_paused ? 'unpause' : 'pause';

      try {
        const res = await fetch(`/api/customers/${customerId}/${action}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: `${action}d by admin` })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error);

        alert(`Account ${action}d successfully`);
        window.location.reload();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Remove discount
    async function removeDiscount() {
      if (!confirm('Remove discount from this customer?')) return;

      try {
        const res = await fetch(`/api/customers/${customerId}/remove-discount`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: 'Removed by admin' })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error);

        alert('Discount removed');
        window.location.reload();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Show add credits modal (simple prompt for now)
    function showAddCreditsModal() {
      const credits = prompt('Enter number of credits to add:');
      if (!credits || isNaN(credits) || credits <= 0) return;

      const reason = prompt('Reason for adding credits:') || 'Admin gift';

      fetch(`/api/customers/${customerId}/add-credits`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ credits: parseFloat(credits), reason })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(`${credits} credits added!`);
          window.location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(err => alert('Error: ' + err.message));
    }

    // Show set discount modal (simple prompt for now)
    function showSetDiscountModal() {
      const percent = prompt('Discount percentage (10, 20, 30, 40, or 50):');
      if (!percent || ![10, 20, 30, 40, 50].includes(parseInt(percent))) {
        alert('Invalid percentage. Must be 10, 20, 30, 40, or 50');
        return;
      }

      const type = prompt('Discount type (church, nonprofit, educational, community, partner, other):') || 'other';
      const reason = prompt('Reason:') || '';

      fetch(`/api/customers/${customerId}/set-discount`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          discountPercent: parseInt(percent),
          discountType: type,
          reason
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(`${percent}% discount applied!`);
          window.location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(err => alert('Error: ' + err.message));
    }

    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/login';
      } catch (error) {
        console.error('Logout error:', error);
      }
    }

    // Load on page load
    document.addEventListener('DOMContentLoaded', loadCustomer);
  </script>
</body>
</html>
