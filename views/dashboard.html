<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Open Word Admin</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>Open Word</h1>
        <p>Admin Dashboard</p>
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li>
            <a href="/dashboard" class="active">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
              </svg>
              Dashboard
            </a>
          </li>
          <li>
            <a href="/customers">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
              Customers
            </a>
          </li>
          <li>
            <a href="/pricing">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Pricing
            </a>
          </li>
          <li>
            <a href="/costs">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Costs
            </a>
          </li>
          <li>
            <a href="/charity-registers">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              Charity Registers
            </a>
          </li>
          <li>
            <a href="/communications">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              Communications
            </a>
          </li>
          <li>
            <a href="/monitoring">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              Monitoring
            </a>
          </li>
          <li>
            <a href="/analytics">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
              </svg>
              Analytics
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar-footer">
        <button onclick="logout()">Sign Out</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h2>Dashboard</h2>
        <p>Overview of your Open Word system</p>
      </div>

      <!-- System Status Alert -->
      <div id="systemAlert" class="alert" style="display: none;"></div>

      <!-- Pending Charity Reviews Alert -->
      <div id="charityReviewAlert" class="card" style="display: none; border-left: 4px solid #f59e0b; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
        <div class="card-header" style="border-bottom: 1px solid rgba(0,0,0,0.1);">
          <h3 style="color: #92400e; display: flex; align-items: center; gap: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 24px; height: 24px;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            Pending Charity Reviews
          </h3>
          <span class="badge badge-warning" id="charityReviewCount" style="font-size: 14px;">0</span>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Organisation</th>
                <th>Charity Number</th>
                <th>Region</th>
                <th>Contact</th>
                <th>Requested</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="charityReviewsTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Pending Discount Reviews Alert -->
      <div id="discountReviewAlert" class="card" style="display: none; border-left: 4px solid #3b82f6; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
        <div class="card-header" style="border-bottom: 1px solid rgba(0,0,0,0.1);">
          <h3 style="color: #1e40af; display: flex; align-items: center; gap: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 24px; height: 24px;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Pending Discount Requests
          </h3>
          <span class="badge" id="discountReviewCount" style="font-size: 14px; background: #3b82f6; color: white;">0</span>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Organisation</th>
                <th>Plan</th>
                <th>Contact</th>
                <th>Reason</th>
                <th>Requested</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="discountReviewsTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Key Stats -->
      <div class="stats-grid">
        <div class="stat-card primary">
          <div class="label">Total Customers</div>
          <div class="value" id="totalCustomers">-</div>
          <div class="change" id="newCustomersChange"></div>
        </div>
        <div class="stat-card success">
          <div class="label">Active Customers</div>
          <div class="value" id="activeCustomers">-</div>
        </div>
        <div class="stat-card warning">
          <div class="label">Trial Customers</div>
          <div class="value" id="trialCustomers">-</div>
        </div>
        <div class="stat-card danger">
          <div class="label">Payment Issues</div>
          <div class="value" id="paymentIssues">-</div>
        </div>
      </div>

      <!-- Revenue & Usage -->
      <div class="grid grid-2">
        <div class="card">
          <div class="card-header">
            <h3>Revenue</h3>
          </div>
          <div class="stats-grid" style="margin-bottom: 0;">
            <div>
              <div class="text-muted mb-2">This Month</div>
              <div style="font-size: 1.5rem; font-weight: 700;" id="revenueThisMonth">-</div>
            </div>
            <div>
              <div class="text-muted mb-2">Last Month</div>
              <div style="font-size: 1.5rem; font-weight: 700;" id="revenueLastMonth">-</div>
            </div>
            <div>
              <div class="text-muted mb-2">MRR</div>
              <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="mrr">-</div>
            </div>
            <div>
              <div class="text-muted mb-2">Active Subs</div>
              <div style="font-size: 1.5rem; font-weight: 700;" id="activeSubs">-</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Usage This Month</h3>
          </div>
          <div class="stats-grid" style="margin-bottom: 0;">
            <div>
              <div class="text-muted mb-2">Characters</div>
              <div style="font-size: 1.5rem; font-weight: 700;" id="usageChars">-</div>
            </div>
            <div>
              <div class="text-muted mb-2">Est. Cost</div>
              <div style="font-size: 1.5rem; font-weight: 700;" id="usageCost">-</div>
            </div>
            <div>
              <div class="text-muted mb-2">vs Last Month</div>
              <div style="font-size: 1.5rem; font-weight: 700;" id="usageChange">-</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Credit System Stats -->
      <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
        <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
          <h3 style="color: white;">Credit System</h3>
        </div>
        <div class="stats-grid" style="margin-bottom: 0;">
          <div>
            <div style="opacity: 0.9; margin-bottom: 8px;">Total Credits in Circulation</div>
            <div style="font-size: 2rem; font-weight: 700;" id="totalCredits">-</div>
          </div>
          <div>
            <div style="opacity: 0.9; margin-bottom: 8px;">Credits Purchased (Month)</div>
            <div style="font-size: 2rem; font-weight: 700;" id="creditsPurchasedMonth">-</div>
          </div>
          <div>
            <div style="opacity: 0.9; margin-bottom: 8px;">Credits Used (Month)</div>
            <div style="font-size: 2rem; font-weight: 700;" id="creditsUsedMonth">-</div>
          </div>
          <div>
            <div style="opacity: 0.9; margin-bottom: 8px;">Credit Revenue (Month)</div>
            <div style="font-size: 2rem; font-weight: 700;" id="creditRevenueMonth">-</div>
          </div>
        </div>
      </div>

      <!-- Low Balance Alert -->
      <div id="lowBalanceAlert" class="card" style="display: none; border-left: 4px solid var(--warning);">
        <div class="card-header">
          <h3>Low Balance Customers</h3>
          <span class="badge badge-warning" id="lowBalanceCount">0</span>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Customer</th>
                <th>Tier</th>
                <th>Balance</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="lowBalanceCustomers"></tbody>
          </table>
        </div>
      </div>

      <!-- Tier Breakdown -->
      <div class="card">
        <div class="card-header">
          <h3>Customers by Tier</h3>
        </div>
        <div id="tierBreakdown" class="stats-grid" style="margin-bottom: 0;">
          <div>
            <div class="text-muted mb-2">Basic</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: #6b7280;" id="tierBasic">-</div>
          </div>
          <div>
            <div class="text-muted mb-2">Standard</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;" id="tierStandard">-</div>
          </div>
          <div>
            <div class="text-muted mb-2">Pro</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;" id="tierPro">-</div>
          </div>
          <div>
            <div class="text-muted mb-2">Enterprise</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;" id="tierEnterprise">-</div>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="grid grid-2">
        <div class="card">
          <div class="card-header">
            <h3>Recent Signups</h3>
            <a href="/customers" class="btn btn-sm btn-outline">View All</a>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Plan</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody id="recentSignups">
                <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Recent Usage</h3>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Customer</th>
                  <th>Type</th>
                  <th>Characters</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="recentUsage">
                <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Last Updated -->
      <p class="text-muted text-center mt-4">
        Last updated: <span id="lastUpdated">-</span>
        <button onclick="refreshData()" class="btn btn-sm btn-outline" style="margin-left: 10px;">Refresh</button>
      </p>
    </main>
  </div>

  <script>
    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: 'GBP'
      }).format(amount);
    }

    // Format number
    function formatNumber(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      }
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toLocaleString();
    }

    // Format date
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Get status badge
    function getStatusBadge(status) {
      const badges = {
        active: '<span class="badge badge-success">Active</span>',
        trialing: '<span class="badge badge-info">Trial</span>',
        past_due: '<span class="badge badge-warning">Past Due</span>',
        unpaid: '<span class="badge badge-danger">Unpaid</span>',
        canceled: '<span class="badge badge-gray">Cancelled</span>',
      };
      return badges[status] || `<span class="badge badge-gray">${status}</span>`;
    }

    // Load dashboard summary
    async function loadSummary() {
      try {
        const response = await fetch('/api/dashboard/summary');
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const { customers, planBreakdown, usage } = data.data;

        // Update customer stats
        document.getElementById('totalCustomers').textContent = customers.total;
        document.getElementById('activeCustomers').textContent = customers.active;
        document.getElementById('trialCustomers').textContent = customers.trial;
        document.getElementById('paymentIssues').textContent = customers.paymentIssues;

        if (customers.newThisMonth > 0) {
          document.getElementById('newCustomersChange').textContent = `+${customers.newThisMonth} this month`;
          document.getElementById('newCustomersChange').classList.add('positive');
        }

        // Show alert if there are payment issues
        if (customers.paymentIssues > 0) {
          const alertDiv = document.getElementById('systemAlert');
          alertDiv.className = 'alert alert-warning';
          alertDiv.innerHTML = `<strong>Attention:</strong> ${customers.paymentIssues} customer(s) have payment issues that need attention.`;
          alertDiv.style.display = 'flex';
        }

        // Update usage stats
        document.getElementById('usageChars').textContent = formatNumber(usage.thisMonth.characters);
        document.getElementById('usageCost').textContent = formatCurrency(usage.thisMonth.cost);

        // Calculate change
        if (usage.lastMonth.characters > 0) {
          const changePercent = ((usage.thisMonth.characters - usage.lastMonth.characters) / usage.lastMonth.characters * 100).toFixed(0);
          const changeText = changePercent > 0 ? `+${changePercent}%` : `${changePercent}%`;
          document.getElementById('usageChange').textContent = changeText;
          document.getElementById('usageChange').style.color = changePercent > 0 ? 'var(--success)' : 'var(--danger)';
        }

        document.getElementById('lastUpdated').textContent = formatDate(data.data.timestamp);
      } catch (error) {
        console.error('Error loading summary:', error);
      }
    }

    // Load revenue data
    async function loadRevenue() {
      try {
        const response = await fetch('/api/dashboard/revenue');
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        document.getElementById('revenueThisMonth').textContent = formatCurrency(data.data.revenueThisMonth);
        document.getElementById('revenueLastMonth').textContent = formatCurrency(data.data.revenueLastMonth);
        document.getElementById('mrr').textContent = formatCurrency(data.data.mrr);
        document.getElementById('activeSubs').textContent = data.data.activeSubscriptions;
      } catch (error) {
        console.error('Error loading revenue:', error);
      }
    }

    // Load credit system stats
    async function loadCredits() {
      try {
        const response = await fetch('/api/dashboard/credits');
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const { balances, thisMonth, tiers } = data.data;

        // Update credit stats
        document.getElementById('totalCredits').textContent = formatNumber(balances.totalCurrent.toFixed(1));
        document.getElementById('creditsPurchasedMonth').textContent = formatNumber(thisMonth.creditsPurchased.toFixed(1));
        document.getElementById('creditsUsedMonth').textContent = formatNumber(thisMonth.creditsUsed.toFixed(1));
        document.getElementById('creditRevenueMonth').textContent = formatCurrency(thisMonth.revenue);

        // Update tier breakdown
        document.getElementById('tierBasic').textContent = tiers.basic || 0;
        document.getElementById('tierStandard').textContent = tiers.standard || 0;
        document.getElementById('tierPro').textContent = tiers.pro || 0;
        document.getElementById('tierEnterprise').textContent = tiers.enterprise || 0;

      } catch (error) {
        console.error('Error loading credit stats:', error);
      }
    }

    // Load pending charity reviews
    async function loadCharityReviews() {
      try {
        const response = await fetch('/api/dashboard/pending-charity-reviews');
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const alertDiv = document.getElementById('charityReviewAlert');
        const countBadge = document.getElementById('charityReviewCount');
        const tableBody = document.getElementById('charityReviewsTable');

        if (data.data.count === 0) {
          alertDiv.style.display = 'none';
          return;
        }

        // Show the alert section
        alertDiv.style.display = 'block';
        countBadge.textContent = data.data.count;

        // Populate table
        tableBody.innerHTML = data.data.reviews.map(review => `
          <tr>
            <td>
              <a href="/customers/${review.id}" style="color: #92400e; font-weight: 600;">${review.name}</a>
              ${review.is_charity ? '<span class="badge badge-info" style="margin-left: 4px; font-size: 10px;">Claims Charity</span>' : ''}
            </td>
            <td>${review.charity_number || '<span class="text-muted">Not provided</span>'}</td>
            <td>${review.charity_region || '<span class="text-muted">Unknown</span>'}</td>
            <td>${review.contact_name || 'Unknown'}</td>
            <td>${formatDate(review.charity_review_requested_at)}</td>
            <td style="white-space: nowrap;">
              <button onclick="grantCharityDiscount('${review.id}', '${review.name.replace(/'/g, "\\'")}')"
                      class="btn btn-sm" style="background: #10b981; color: white; margin-right: 4px;">
                Grant 50%
              </button>
              <button onclick="denyCharityDiscount('${review.id}', '${review.name.replace(/'/g, "\\'")}')"
                      class="btn btn-sm btn-outline" style="color: #dc2626; border-color: #dc2626;">
                Deny
              </button>
            </td>
          </tr>
        `).join('');

      } catch (error) {
        console.error('Error loading charity reviews:', error);
      }
    }

    // Grant charity discount
    async function grantCharityDiscount(orgId, orgName) {
      const discountPercent = prompt(`Grant charity discount to "${orgName}".\n\nEnter discount percentage (default 50%):`, '50');

      if (discountPercent === null) return; // User cancelled

      const discount = parseInt(discountPercent) || 50;
      const reason = prompt('Enter reason for granting discount (optional):');

      try {
        const response = await fetch(`/api/customers/${orgId}/grant-charity-discount`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ discountPercent: discount, reason })
        });

        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        alert(`Charity discount of ${discount}% granted to ${orgName}`);
        loadCharityReviews(); // Refresh the list
        loadCredits(); // Refresh charity count
      } catch (error) {
        console.error('Error granting discount:', error);
        alert('Failed to grant discount: ' + error.message);
      }
    }

    // Deny charity discount
    async function denyCharityDiscount(orgId, orgName) {
      if (!confirm(`Deny charity status for "${orgName}"?\n\nThis will mark the review as completed without granting a discount.`)) {
        return;
      }

      const reason = prompt('Enter reason for denial (optional):');

      try {
        const response = await fetch(`/api/customers/${orgId}/deny-charity-review`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });

        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        alert(`Charity review denied for ${orgName}`);
        loadCharityReviews(); // Refresh the list
      } catch (error) {
        console.error('Error denying review:', error);
        alert('Failed to deny review: ' + error.message);
      }
    }

    // Load pending discount reviews
    async function loadDiscountReviews() {
      try {
        const response = await fetch('/api/dashboard/pending-discount-reviews');
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const alertDiv = document.getElementById('discountReviewAlert');
        const countBadge = document.getElementById('discountReviewCount');
        const tableBody = document.getElementById('discountReviewsTable');

        if (data.data.count === 0) {
          alertDiv.style.display = 'none';
          return;
        }

        // Show the alert section
        alertDiv.style.display = 'block';
        countBadge.textContent = data.data.count;

        // Populate table
        tableBody.innerHTML = data.data.reviews.map(review => `
          <tr>
            <td>
              <a href="/customers/${review.id}" style="color: #1e40af; font-weight: 600;">${review.name}</a>
            </td>
            <td>${review.subscription_tier ? review.subscription_tier.charAt(0).toUpperCase() + review.subscription_tier.slice(1) : 'Unknown'}</td>
            <td>${review.contact_name || 'Unknown'}</td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${review.discount_review_reason || 'No reason provided'}">
              ${review.discount_review_reason || '<span class="text-muted">No reason provided</span>'}
            </td>
            <td>${formatDate(review.discount_review_requested_at)}</td>
            <td style="white-space: nowrap;">
              <button onclick="approveDiscount('${review.id}', '${review.name.replace(/'/g, "\\'")}')"
                      class="btn btn-sm" style="background: #10b981; color: white; margin-right: 4px;">
                Approve
              </button>
              <button onclick="denyDiscount('${review.id}', '${review.name.replace(/'/g, "\\'")}')"
                      class="btn btn-sm btn-outline" style="color: #dc2626; border-color: #dc2626;">
                Deny
              </button>
            </td>
          </tr>
        `).join('');

      } catch (error) {
        console.error('Error loading discount reviews:', error);
      }
    }

    // Approve discount request - opens modal with dropdowns
    function approveDiscount(orgId, orgName) {
      document.getElementById('discountCustomerId').value = orgId;
      document.getElementById('discountModalCustomerName').textContent = `Approving discount for: ${orgName}`;
      document.getElementById('discountModalTitle').textContent = 'Approve Discount';

      // Set defaults for discount requests
      document.getElementById('discountPercentSelect').value = '20';
      document.getElementById('discountTypeSelect').value = 'nonprofit';
      document.getElementById('discountReasonInput').value = '';

      // Show modal
      document.getElementById('discountModal').classList.add('active');
    }

    // Deny discount request
    async function denyDiscount(orgId, orgName) {
      if (!confirm(`Deny discount request for "${orgName}"?`)) {
        return;
      }

      const reason = prompt('Enter reason for denial:');

      try {
        const response = await fetch(`/api/customers/${orgId}/deny-discount-request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: reason || 'Request denied' })
        });

        const data = await response.json();

        if (!data.success) throw new Error(data.error || data.message);

        alert(`Discount request denied for ${orgName}`);
        loadDiscountReviews(); // Refresh the list
      } catch (error) {
        console.error('Error denying discount:', error);
        alert('Failed to deny discount: ' + error.message);
      }
    }

    // Load low balance customers
    async function loadLowBalanceCustomers() {
      try {
        const response = await fetch('/api/dashboard/low-balance-customers?threshold=10');
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const alertDiv = document.getElementById('lowBalanceAlert');
        const countBadge = document.getElementById('lowBalanceCount');
        const tableBody = document.getElementById('lowBalanceCustomers');

        if (data.data.customers.length === 0) {
          alertDiv.style.display = 'none';
          return;
        }

        // Show the alert section
        alertDiv.style.display = 'block';
        countBadge.textContent = data.data.count;

        // Get tier badge
        function getTierBadge(tier) {
          const badges = {
            basic: '<span class="badge" style="background: #6b7280; color: white;">Basic</span>',
            standard: '<span class="badge" style="background: #3b82f6; color: white;">Standard</span>',
            pro: '<span class="badge" style="background: #f59e0b; color: white;">Pro</span>',
            enterprise: '<span class="badge" style="background: #8b5cf6; color: white;">Enterprise</span>'
          };
          return badges[tier] || badges.basic;
        }

        // Populate table
        tableBody.innerHTML = data.data.customers.map(customer => `
          <tr>
            <td>
              <a href="/customers/${customer.id}">${customer.name}</a>
              ${customer.isCharity ? '<span class="badge badge-success" style="margin-left: 4px; font-size: 10px;">Charity</span>' : ''}
            </td>
            <td>${getTierBadge(customer.tier)}</td>
            <td style="font-weight: 600; color: ${customer.currentBalance <= 0 ? 'var(--danger)' : 'var(--warning)'};">
              ${customer.currentBalance.toFixed(2)} credits
            </td>
            <td>
              <a href="/customers/${customer.id}" class="btn btn-sm btn-outline">View</a>
            </td>
          </tr>
        `).join('');

      } catch (error) {
        console.error('Error loading low balance customers:', error);
      }
    }

    // Load recent activity
    async function loadActivity() {
      try {
        const response = await fetch('/api/dashboard/recent-activity?limit=5');
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        // Recent signups
        const signupsTable = document.getElementById('recentSignups');
        if (data.data.recentSignups.length === 0) {
          signupsTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No recent signups</td></tr>';
        } else {
          signupsTable.innerHTML = data.data.recentSignups.map(signup => `
            <tr>
              <td><a href="/customers/${signup.id}">${signup.name || 'Unnamed'}</a></td>
              <td>${signup.subscription_tier || '-'}</td>
              <td>${getStatusBadge(signup.subscription_status)}</td>
              <td>${formatDate(signup.created_at)}</td>
            </tr>
          `).join('');
        }

        // Recent usage
        const usageTable = document.getElementById('recentUsage');
        if (data.data.recentUsage.length === 0) {
          usageTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No recent usage</td></tr>';
        } else {
          usageTable.innerHTML = data.data.recentUsage.map(usage => `
            <tr>
              <td>${usage.organisations?.name || 'Unknown'}</td>
              <td>${usage.operation_type}</td>
              <td>${formatNumber(usage.character_count)}</td>
              <td>${formatDate(usage.created_at)}</td>
            </tr>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading activity:', error);
      }
    }

    // Refresh all data
    function refreshData() {
      loadSummary();
      loadRevenue();
      loadCredits();
      loadCharityReviews();
      loadDiscountReviews();
      loadLowBalanceCustomers();
      loadActivity();
    }

    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/login';
      } catch (error) {
        console.error('Logout error:', error);
      }
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
      refreshData();

      // Auto-refresh every 5 minutes
      setInterval(refreshData, 5 * 60 * 1000);
    });

    // Discount modal functions
    function closeDiscountModal() {
      document.getElementById('discountModal').classList.remove('active');
    }

    async function submitDiscount() {
      const id = document.getElementById('discountCustomerId').value;
      const percent = parseInt(document.getElementById('discountPercentSelect').value);
      const discountType = document.getElementById('discountTypeSelect').value;
      const reason = document.getElementById('discountReasonInput').value.trim();

      if (!percent) {
        alert('Please select a discount percentage.');
        return;
      }
      if (!discountType) {
        alert('Please select a discount type.');
        return;
      }

      try {
        const response = await fetch(`/api/customers/${id}/set-discount`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ discountPercent: percent, discountType, reason: reason || 'Approved discount request' })
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error || data.message);

        closeDiscountModal();

        let message = `${percent}% discount granted successfully.`;
        if (data.stripeCouponApplied) {
          message += '\n\nStripe subscription updated.';
        }
        alert(message);

        loadDiscountReviews(); // Refresh the list
      } catch (error) {
        console.error('Error granting discount:', error);
        alert('Failed to grant discount: ' + error.message);
      }
    }
  </script>

  <!-- Discount Modal -->
  <div class="modal-overlay" id="discountModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; max-width: 450px; width: 90%; margin: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
      <div style="padding: 16px 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-size: 18px;" id="discountModalTitle">Approve Discount</h3>
        <button onclick="closeDiscountModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>
      <div style="padding: 20px;">
        <p id="discountModalCustomerName" style="margin-bottom: 16px; color: #6b7280;"></p>

        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 500;">Discount Percentage: *</label>
          <select id="discountPercentSelect" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
            <option value="">Select percentage...</option>
            <option value="10">10%</option>
            <option value="20" selected>20%</option>
            <option value="30">30%</option>
            <option value="40">40%</option>
            <option value="50">50%</option>
          </select>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 500;">Discount Type: *</label>
          <select id="discountTypeSelect" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
            <option value="">Select type...</option>
            <option value="charity">Charity - Registered charity</option>
            <option value="church">Church - Church or religious organisation</option>
            <option value="nonprofit" selected>Nonprofit - Non-profit organisation</option>
            <option value="educational">Educational - Educational institution</option>
            <option value="community">Community - Community organisation</option>
            <option value="partner">Partner - Partnership agreement</option>
            <option value="promotional">Promotional - Promotional offer</option>
            <option value="negotiated">Negotiated - Negotiated rate</option>
            <option value="other">Other - Other reason</option>
          </select>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 500;">Reason (optional):</label>
          <input type="text" id="discountReasonInput" placeholder="Enter reason for discount..." style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
        </div>

        <input type="hidden" id="discountCustomerId">
      </div>
      <div style="padding: 16px 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 10px;">
        <button onclick="closeDiscountModal()" style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
        <button onclick="submitDiscount()" style="padding: 10px 20px; border: none; background: #2563eb; color: white; border-radius: 6px; cursor: pointer;">Apply Discount</button>
      </div>
    </div>
  </div>

  <style>
    #discountModal.active { display: flex !important; }
  </style>
</body>
</html>
