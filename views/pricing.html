<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pricing - Open Word Admin</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .tier-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 2px solid var(--gray-200);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .tier-card:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .tier-card.inactive {
      opacity: 0.6;
      border-color: var(--gray-300);
    }
    .tier-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .tier-name {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-900);
    }
    .tier-id {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 2px;
    }
    .tier-price {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
    .tier-price small {
      font-size: 0.875rem;
      font-weight: 400;
      color: var(--gray-500);
    }
    .tier-prices {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 12px;
      padding: 12px;
      background: var(--gray-50);
      border-radius: 8px;
    }
    .tier-prices .price-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }
    .tier-prices .price-row .currency-label {
      font-weight: 500;
      color: var(--gray-600);
      min-width: 40px;
    }
    .tier-prices .price-row .price-value {
      font-weight: 600;
      color: var(--gray-900);
    }
    .tier-prices .price-row .price-missing {
      color: var(--gray-400);
      font-style: italic;
    }
    .tier-details {
      margin: 16px 0;
      padding: 16px 0;
      border-top: 1px solid var(--gray-200);
      border-bottom: 1px solid var(--gray-200);
    }
    .tier-detail {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 0.875rem;
    }
    .tier-detail label {
      color: var(--gray-600);
    }
    .tier-detail span {
      font-weight: 500;
      color: var(--gray-900);
    }
    .tier-actions {
      margin-top: 16px;
      display: flex;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>Open Word</h1>
        <p>Admin Dashboard</p>
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li>
            <a href="/dashboard">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
              </svg>
              Dashboard
            </a>
          </li>
          <li>
            <a href="/customers">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
              Customers
            </a>
          </li>
          <li>
            <a href="/pricing" class="active">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Pricing
            </a>
          </li>
          <li>
            <a href="/costs">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Costs
            </a>
          </li>
          <li>
            <a href="/charity-registers">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              Charity Registers
            </a>
          </li>
          <li>
            <a href="/communications">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              Communications
            </a>
          </li>
          <li>
            <a href="/monitoring">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              Monitoring
            </a>
          </li>
          <li>
            <a href="/analytics">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
              </svg>
              Analytics
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar-footer">
        <button onclick="logout()">Sign Out</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <div>
          <h2>Plan Pricing</h2>
          <p>View subscription tier pricing from Stripe</p>
        </div>
      </div>

      <p style="color: var(--gray-500); margin-bottom: 24px;">Prices are managed in Stripe. Edit products in your <a href="https://dashboard.stripe.com/products" target="_blank" style="color: var(--primary);">Stripe Dashboard</a> to change pricing.</p>

      <!-- Subscription Plans Grid -->
      <h3 style="margin-bottom: 16px;">Subscription Plans</h3>
      <div class="pricing-grid" id="plansGrid">
        <div class="tier-card">
          <p class="text-muted text-center">Loading plans...</p>
        </div>
      </div>

      <!-- Credit Packages Grid -->
      <h3 style="margin-bottom: 16px; margin-top: 32px;">Credit Packages</h3>
      <div class="pricing-grid" id="creditsGrid">
        <div class="tier-card">
          <p class="text-muted text-center">Loading credits...</p>
        </div>
      </div>

      <!-- Credit Configuration Section -->
      <h3 style="margin-bottom: 16px; margin-top: 32px;">Credit Configuration</h3>
      <p style="color: var(--gray-500); margin-bottom: 16px;">Configure how many characters equal one credit for each plan tier.</p>

      <div class="tier-card" style="max-width: 600px;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid var(--gray-200);">
              <th style="text-align: left; padding: 12px 8px; color: var(--gray-600); font-weight: 600;">Plan</th>
              <th style="text-align: left; padding: 12px 8px; color: var(--gray-600); font-weight: 600;">Characters per Credit</th>
              <th style="text-align: center; padding: 12px 8px; color: var(--gray-600); font-weight: 600;">Action</th>
            </tr>
          </thead>
          <tbody id="creditConfigTable">
            <tr>
              <td colspan="3" style="padding: 20px; text-align: center; color: var(--gray-500);">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>

    </main>
  </div>

  <script>
    // Currency configuration
    const CURRENCIES = ['gbp', 'usd', 'eur'];
    const CURRENCY_CONFIG = {
      gbp: { symbol: '£', locale: 'en-GB', name: 'GBP' },
      usd: { symbol: '$', locale: 'en-US', name: 'USD' },
      eur: { symbol: '€', locale: 'de-DE', name: 'EUR' }
    };

    // Format currency from smallest unit (pence/cents)
    function formatCurrency(amount, currency = 'gbp') {
      const config = CURRENCY_CONFIG[currency.toLowerCase()] || CURRENCY_CONFIG.gbp;
      return new Intl.NumberFormat(config.locale, {
        style: 'currency',
        currency: currency.toUpperCase()
      }).format(amount / 100);
    }

    // Render price rows for all currencies
    function renderPriceRows(prices, suffix = '') {
      return CURRENCIES.map(currency => {
        const price = prices[currency];
        const config = CURRENCY_CONFIG[currency];
        if (price && price.amount) {
          return `
            <div class="price-row">
              <span class="currency-label">${config.name}</span>
              <span class="price-value">${formatCurrency(price.amount, currency)}${suffix}</span>
            </div>
          `;
        } else {
          return `
            <div class="price-row">
              <span class="currency-label">${config.name}</span>
              <span class="price-missing">Not configured</span>
            </div>
          `;
        }
      }).join('');
    }

    // Load pricing from Stripe (plans and credits)
    async function loadPricing() {
      try {
        const response = await fetch('/api/pricing/stripe');
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const { plans, credits } = data.data;

        // Render subscription plans
        const plansGrid = document.getElementById('plansGrid');
        if (plans.length === 0) {
          plansGrid.innerHTML = '<div class="tier-card"><p class="text-muted text-center">No subscription plans found in Stripe.</p></div>';
        } else {
          plansGrid.innerHTML = plans.map(plan => `
            <div class="tier-card">
              <div class="tier-header">
                <div>
                  <div class="tier-name">${plan.name}</div>
                  <div class="tier-id" style="font-size: 0.7rem; color: var(--gray-400);">${plan.stripeProductId}</div>
                </div>
              </div>
              ${plan.description ? `<p style="font-size: 0.875rem; color: var(--gray-500); margin-top: 8px;">${plan.description}</p>` : ''}
              <div class="tier-prices">
                <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 4px;">Monthly Prices</div>
                ${renderPriceRows(plan.prices, '/mo')}
              </div>
              <div class="tier-actions" style="margin-top: 16px;">
                <a href="https://dashboard.stripe.com/products/${plan.stripeProductId}" target="_blank" class="btn btn-sm btn-outline">Edit in Stripe</a>
              </div>
            </div>
          `).join('');
        }

        // Render credit packages
        const creditsGrid = document.getElementById('creditsGrid');
        if (credits.length === 0) {
          creditsGrid.innerHTML = '<div class="tier-card"><p class="text-muted text-center">No credit packages found in Stripe.</p></div>';
        } else {
          creditsGrid.innerHTML = credits.map(credit => `
            <div class="tier-card">
              <div class="tier-header">
                <div>
                  <div class="tier-name">${credit.name}</div>
                  <div class="tier-id" style="font-size: 0.7rem; color: var(--gray-400);">${credit.stripeProductId}</div>
                </div>
              </div>
              ${credit.description ? `<p style="font-size: 0.875rem; color: var(--gray-500); margin-top: 8px;">${credit.description}</p>` : ''}
              <div class="tier-prices">
                <div style="font-size: 0.75rem; color: var(--gray-500); margin-bottom: 4px;">Package Prices</div>
                ${renderPriceRows(credit.prices, '')}
              </div>
              <div class="tier-actions" style="margin-top: 16px;">
                <a href="https://dashboard.stripe.com/products/${credit.stripeProductId}" target="_blank" class="btn btn-sm btn-outline">Edit in Stripe</a>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading pricing:', error);
        document.getElementById('plansGrid').innerHTML =
          '<div class="tier-card"><p class="text-danger text-center">Error loading plans from Stripe</p></div>';
        document.getElementById('creditsGrid').innerHTML =
          '<div class="tier-card"><p class="text-danger text-center">Error loading credits from Stripe</p></div>';
      }
    }

    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/login';
      } catch (error) {
        console.error('Logout error:', error);
      }
    }

    // Load credit configuration from database
    async function loadCreditConfig() {
      try {
        const response = await fetch('/api/pricing');
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const tiers = data.data;
        const tableBody = document.getElementById('creditConfigTable');

        if (tiers.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="3" style="padding: 20px; text-align: center; color: var(--gray-500);">No pricing tiers found</td></tr>';
          return;
        }

        tableBody.innerHTML = tiers.map(tier => `
          <tr style="border-bottom: 1px solid var(--gray-100);" data-tier-id="${tier.id}">
            <td style="padding: 12px 8px;">
              <div style="font-weight: 500; color: var(--gray-900);">${tier.name}</div>
              <div style="font-size: 0.75rem; color: var(--gray-500);">${tier.id}</div>
            </td>
            <td style="padding: 12px 8px;">
              <input
                type="number"
                id="chars-${tier.id}"
                value="${tier.chars_per_credit || 23000}"
                min="1000"
                max="100000"
                step="1000"
                style="width: 120px; padding: 8px 12px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 0.9rem;"
              />
            </td>
            <td style="padding: 12px 8px; text-align: center;">
              <button
                onclick="saveCharsPerCredit('${tier.id}')"
                class="btn btn-sm btn-primary"
                id="save-btn-${tier.id}"
              >
                Save
              </button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading credit config:', error);
        document.getElementById('creditConfigTable').innerHTML =
          '<tr><td colspan="3" style="padding: 20px; text-align: center; color: var(--danger);">Error loading configuration</td></tr>';
      }
    }

    // Save chars per credit for a tier
    async function saveCharsPerCredit(tierId) {
      const input = document.getElementById(`chars-${tierId}`);
      const button = document.getElementById(`save-btn-${tierId}`);
      const newValue = parseInt(input.value, 10);

      if (isNaN(newValue) || newValue < 1000 || newValue > 100000) {
        alert('Please enter a valid number between 1,000 and 100,000');
        return;
      }

      button.disabled = true;
      button.textContent = 'Saving...';

      try {
        const response = await fetch(`/api/pricing/${tierId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ charsPerCredit: newValue })
        });

        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        button.textContent = 'Saved!';
        button.style.background = 'var(--success)';

        setTimeout(() => {
          button.textContent = 'Save';
          button.style.background = '';
          button.disabled = false;
        }, 2000);

        console.log(`✅ Updated ${tierId} chars_per_credit to ${newValue}`);
      } catch (error) {
        console.error('Error saving chars per credit:', error);
        alert('Failed to save. Please try again.');
        button.textContent = 'Save';
        button.disabled = false;
      }
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadPricing();
      loadCreditConfig();
    });
  </script>
</body>
</html>
