<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pricing - OpenWord Admin</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>OpenWord</h1>
        <p>Admin Dashboard</p>
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li>
            <a href="/dashboard">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
              </svg>
              Dashboard
            </a>
          </li>
          <li>
            <a href="/customers">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
              Customers
            </a>
          </li>
          <li>
            <a href="/pricing" class="active">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Pricing
            </a>
          </li>
          <li>
            <a href="/costs">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Costs
            </a>
          </li>
          <li>
            <a href="/monitoring">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              Monitoring
            </a>
          </li>
          <li>
            <a href="/analytics">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
              </svg>
              Analytics
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar-footer">
        <button onclick="logout()">Sign Out</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header flex justify-between items-center">
        <div>
          <h2>Subscription Pricing</h2>
          <p>Manage subscription tiers and pricing</p>
        </div>
        <button class="btn btn-primary" onclick="showAddTierModal()">Add Tier</button>
      </div>

      <!-- Pricing Tiers Table -->
      <div class="card">
        <div class="card-header">
          <h3>Pricing Tiers</h3>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Plan</th>
                <th>Monthly Fee</th>
                <th>Usage Rate</th>
                <th>Min Monthly</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tiersTable">
              <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Current Stripe Products -->
      <div class="card">
        <div class="card-header">
          <h3>Stripe Products</h3>
          <button class="btn btn-sm btn-outline" onclick="loadStripeProducts()">Refresh from Stripe</button>
        </div>
        <div id="stripeProducts" class="text-muted text-center" style="padding: 20px;">
          Loading Stripe products...
        </div>
      </div>

      <!-- Pricing Notes -->
      <div class="card">
        <h3 style="margin-bottom: 15px;">Pricing Model</h3>
        <ul style="color: var(--gray-600); line-height: 1.8;">
          <li><strong>Monthly Fee:</strong> Fixed monthly subscription cost</li>
          <li><strong>Usage Rate:</strong> Per-character rate (e.g., £0.000048 = £48 per million characters)</li>
          <li><strong>Minimum Monthly:</strong> Minimum charge per month (for pay-as-you-go plans)</li>
          <li>Changes here update the <code>subscription_pricing</code> table used by the main OpenWord system</li>
        </ul>
      </div>
    </main>
  </div>

  <!-- Edit Tier Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="editModalTitle">Edit Pricing Tier</h3>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editForm" onsubmit="saveTier(event)">
        <div class="modal-body">
          <input type="hidden" id="tierId">

          <div class="grid grid-2">
            <div class="form-group">
              <label for="planName">Plan Name (identifier)</label>
              <input type="text" id="planName" class="form-input" required pattern="[a-z_]+" title="Lowercase letters and underscores only">
            </div>
            <div class="form-group">
              <label for="displayName">Display Name</label>
              <input type="text" id="displayName" class="form-input" required>
            </div>
          </div>

          <div class="grid grid-3">
            <div class="form-group">
              <label for="monthlyFee">Monthly Fee (£)</label>
              <input type="number" id="monthlyFee" class="form-input" step="0.01" min="0" required>
            </div>
            <div class="form-group">
              <label for="usageRate">Usage Rate (per char)</label>
              <input type="number" id="usageRate" class="form-input" step="0.000001" min="0" required>
              <small class="text-muted">e.g., 0.000048</small>
            </div>
            <div class="form-group">
              <label for="minimumMonthlyFee">Min Monthly (£)</label>
              <input type="number" id="minimumMonthlyFee" class="form-input" step="0.01" min="0" required>
            </div>
          </div>

          <div class="form-group">
            <label for="features">Features (one per line)</label>
            <textarea id="features" class="form-input" rows="5" placeholder="25 Source languages&#10;Translation to over 100 languages&#10;Unlimited clients"></textarea>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label for="stripeMonthlyPriceId">Stripe Monthly Price ID</label>
              <input type="text" id="stripeMonthlyPriceId" class="form-input" placeholder="price_xxx">
            </div>
            <div class="form-group">
              <label for="stripeUsagePriceId">Stripe Usage Price ID</label>
              <input type="text" id="stripeUsagePriceId" class="form-input" placeholder="price_xxx">
            </div>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="isActive" checked>
              Active (visible to customers)
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let stripeProducts = [];

    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: 'GBP'
      }).format(amount);
    }

    // Format usage rate
    function formatUsageRate(rate) {
      const perMillion = rate * 1000000;
      return `£${perMillion.toFixed(2)}/M chars`;
    }

    // Load pricing tiers
    async function loadTiers() {
      try {
        const response = await fetch('/api/pricing');
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const table = document.getElementById('tiersTable');
        if (data.data.length === 0) {
          table.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No pricing tiers found.</td></tr>';
        } else {
          table.innerHTML = data.data.map(tier => `
            <tr>
              <td>
                <strong>${tier.display_name}</strong>
                <br><small class="text-muted">${tier.plan_name}</small>
              </td>
              <td>${formatCurrency(tier.monthly_fee || 0)}</td>
              <td>
                ${formatUsageRate(tier.usage_rate || 0)}
                <br><small class="text-muted">£${tier.usage_rate}/char</small>
              </td>
              <td>${formatCurrency(tier.minimum_monthly_fee || 0)}</td>
              <td>
                ${tier.is_active
                  ? '<span class="badge badge-success">Active</span>'
                  : '<span class="badge badge-gray">Inactive</span>'
                }
              </td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editTier('${tier.id}')">Edit</button>
                ${tier.is_active
                  ? `<button class="btn btn-sm btn-danger" onclick="deleteTier('${tier.id}')">Disable</button>`
                  : ''
                }
              </td>
            </tr>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading tiers:', error);
        document.getElementById('tiersTable').innerHTML =
          '<tr><td colspan="6" class="text-center text-danger">Error loading pricing tiers</td></tr>';
      }
    }

    // Load Stripe products
    async function loadStripeProducts() {
      try {
        const response = await fetch('/api/pricing/stripe/products');
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        stripeProducts = data.data;
        const container = document.getElementById('stripeProducts');

        if (stripeProducts.length === 0) {
          container.innerHTML = '<p class="text-muted">No active Stripe products found.</p>';
        } else {
          container.innerHTML = `
            <div class="grid grid-3">
              ${stripeProducts.map(product => `
                <div style="padding: 15px; background: var(--gray-50); border-radius: 8px; text-align: left;">
                  <strong>${product.name}</strong>
                  <p class="text-muted" style="font-size: 0.75rem; margin: 5px 0;">${product.id}</p>
                  <div style="margin-top: 10px; font-size: 0.875rem;">
                    ${product.prices.map(price => `
                      <div style="margin-bottom: 4px;">
                        ${formatCurrency(price.unitAmount)}/${price.interval || 'one-time'}
                        ${price.usageType === 'metered' ? '<span class="badge badge-info" style="font-size: 0.6rem;">metered</span>' : ''}
                        <br><small class="text-muted">${price.id}</small>
                      </div>
                    `).join('')}
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading Stripe products:', error);
        document.getElementById('stripeProducts').innerHTML =
          `<p class="text-danger">Error loading Stripe products: ${error.message}</p>`;
      }
    }

    // Show add tier modal
    function showAddTierModal() {
      document.getElementById('editModalTitle').textContent = 'Add Pricing Tier';
      document.getElementById('tierId').value = '';
      document.getElementById('planName').value = '';
      document.getElementById('planName').disabled = false;
      document.getElementById('displayName').value = '';
      document.getElementById('monthlyFee').value = '0';
      document.getElementById('usageRate').value = '0.000048';
      document.getElementById('minimumMonthlyFee').value = '0';
      document.getElementById('features').value = '';
      document.getElementById('stripeMonthlyPriceId').value = '';
      document.getElementById('stripeUsagePriceId').value = '';
      document.getElementById('isActive').checked = true;
      document.getElementById('editModal').classList.add('active');
    }

    // Edit tier
    async function editTier(id) {
      try {
        const response = await fetch(`/api/pricing/${id}`);
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const tier = data.data;
        document.getElementById('editModalTitle').textContent = 'Edit Pricing Tier';
        document.getElementById('tierId').value = tier.id;
        document.getElementById('planName').value = tier.plan_name || '';
        document.getElementById('planName').disabled = true; // Can't change plan_name after creation
        document.getElementById('displayName').value = tier.display_name || '';
        document.getElementById('monthlyFee').value = tier.monthly_fee || 0;
        document.getElementById('usageRate').value = tier.usage_rate || 0;
        document.getElementById('minimumMonthlyFee').value = tier.minimum_monthly_fee || 0;
        document.getElementById('features').value = (tier.features || []).join('\n');
        document.getElementById('stripeMonthlyPriceId').value = tier.stripe_monthly_price_id || '';
        document.getElementById('stripeUsagePriceId').value = tier.stripe_usage_price_id || '';
        document.getElementById('isActive').checked = tier.is_active;
        document.getElementById('editModal').classList.add('active');
      } catch (error) {
        alert('Error loading tier: ' + error.message);
      }
    }

    // Save tier
    async function saveTier(event) {
      event.preventDefault();

      const id = document.getElementById('tierId').value;
      const tier = {
        planName: document.getElementById('planName').value,
        displayName: document.getElementById('displayName').value,
        monthlyFee: parseFloat(document.getElementById('monthlyFee').value),
        usageRate: parseFloat(document.getElementById('usageRate').value),
        minimumMonthlyFee: parseFloat(document.getElementById('minimumMonthlyFee').value),
        features: document.getElementById('features').value.split('\n').filter(f => f.trim()),
        stripeMonthlyPriceId: document.getElementById('stripeMonthlyPriceId').value || null,
        stripeUsagePriceId: document.getElementById('stripeUsagePriceId').value || null,
        isActive: document.getElementById('isActive').checked,
      };

      try {
        const url = id ? `/api/pricing/${id}` : '/api/pricing';
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(tier),
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert(data.message);
        closeEditModal();
        loadTiers();
      } catch (error) {
        alert('Error saving tier: ' + error.message);
      }
    }

    // Delete (disable) tier
    async function deleteTier(id) {
      if (!confirm('Are you sure you want to disable this pricing tier?')) return;

      try {
        const response = await fetch(`/api/pricing/${id}`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert(data.message);
        loadTiers();
      } catch (error) {
        alert('Error disabling tier: ' + error.message);
      }
    }

    // Close modal
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/login';
      } catch (error) {
        console.error('Logout error:', error);
      }
    }

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadTiers();
      loadStripeProducts();
    });
  </script>
</body>
</html>
