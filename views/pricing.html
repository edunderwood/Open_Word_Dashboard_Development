<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pricing - OpenWord Admin</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .tier-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 2px solid var(--gray-200);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .tier-card:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .tier-card.inactive {
      opacity: 0.6;
      border-color: var(--gray-300);
    }
    .tier-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .tier-name {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-900);
    }
    .tier-id {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 2px;
    }
    .tier-price {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
    .tier-price small {
      font-size: 0.875rem;
      font-weight: 400;
      color: var(--gray-500);
    }
    .tier-details {
      margin: 16px 0;
      padding: 16px 0;
      border-top: 1px solid var(--gray-200);
      border-bottom: 1px solid var(--gray-200);
    }
    .tier-detail {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 0.875rem;
    }
    .tier-detail label {
      color: var(--gray-600);
    }
    .tier-detail span {
      font-weight: 500;
      color: var(--gray-900);
    }
    .tier-features {
      margin-top: 16px;
    }
    .tier-features h4 {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--gray-500);
      margin-bottom: 8px;
    }
    .feature-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      font-size: 0.875rem;
    }
    .feature-item.enabled {
      color: var(--success);
    }
    .feature-item.disabled {
      color: var(--gray-400);
    }
    .tier-actions {
      margin-top: 16px;
      display: flex;
      gap: 8px;
    }
    .charity-card {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 30px;
    }
    .charity-card h3 {
      margin: 0 0 8px 0;
    }
    .charity-card .discount-value {
      font-size: 2rem;
      font-weight: 700;
    }
    .info-card {
      background: var(--gray-50);
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    .info-card h4 {
      margin: 0 0 12px 0;
      color: var(--gray-700);
    }
    .info-card ul {
      margin: 0;
      padding-left: 20px;
      color: var(--gray-600);
      line-height: 1.8;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>OpenWord</h1>
        <p>Admin Dashboard</p>
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li>
            <a href="/dashboard">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
              </svg>
              Dashboard
            </a>
          </li>
          <li>
            <a href="/customers">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
              Customers
            </a>
          </li>
          <li>
            <a href="/pricing" class="active">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Pricing
            </a>
          </li>
          <li>
            <a href="/costs">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Costs
            </a>
          </li>
          <li>
            <a href="/monitoring">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              Monitoring
            </a>
          </li>
          <li>
            <a href="/analytics">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
              </svg>
              Analytics
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar-footer">
        <button onclick="logout()">Sign Out</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <div>
          <h2>Plan Pricing</h2>
          <p>Manage subscription tiers, credit pricing, and charity discounts</p>
        </div>
      </div>

      <!-- Charity Discount Card -->
      <div class="charity-card">
        <h3>Charity Discount</h3>
        <p>Verified charities receive a discount on credit pricing</p>
        <div class="discount-value" id="charityDiscount">50%</div>
        <small>Applied to credit purchases for verified charitable organisations</small>
      </div>

      <!-- Pricing Tiers Grid -->
      <h3 style="margin-bottom: 16px;">Subscription Tiers</h3>
      <div class="pricing-grid" id="tiersGrid">
        <div class="tier-card">
          <p class="text-muted text-center">Loading pricing tiers...</p>
        </div>
      </div>

      <!-- Info Card -->
      <div class="info-card">
        <h4>Pricing Model</h4>
        <ul>
          <li><strong>Monthly Fee:</strong> Fixed subscription cost per month (in pence)</li>
          <li><strong>Credit Price:</strong> Cost per credit for regular customers (in pence)</li>
          <li><strong>Charity Credit Price:</strong> Discounted credit price for verified charities</li>
          <li><strong>Chars per Credit:</strong> Number of characters included per credit (default: 23,000)</li>
          <li>Changes here update the <code>pricing_tiers</code> table used by OpenWord</li>
        </ul>
      </div>
    </main>
  </div>

  <!-- Edit Tier Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3 id="editModalTitle">Edit Pricing Tier</h3>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editForm" onsubmit="saveTier(event)">
        <div class="modal-body">
          <input type="hidden" id="tierId">
          <input type="hidden" id="isNewTier" value="false">

          <div class="grid grid-2">
            <div class="form-group">
              <label for="tierIdInput">Tier ID</label>
              <input type="text" id="tierIdInput" class="form-input" required pattern="[a-z_]+" title="Lowercase letters and underscores only" placeholder="e.g., basic">
              <small class="text-muted">Cannot be changed after creation</small>
            </div>
            <div class="form-group">
              <label for="tierName">Display Name</label>
              <input type="text" id="tierName" class="form-input" required placeholder="e.g., Basic">
            </div>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label for="monthlyFeePence">Monthly Fee (pence)</label>
              <input type="number" id="monthlyFeePence" class="form-input" min="0" required placeholder="1200">
              <small class="text-muted">e.g., 1200 = £12.00</small>
            </div>
            <div class="form-group">
              <label for="charsPerCredit">Characters per Credit</label>
              <input type="number" id="charsPerCredit" class="form-input" min="1000" required placeholder="23000">
            </div>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label for="creditPricePence">Credit Price (pence)</label>
              <input type="number" id="creditPricePence" class="form-input" min="0" required placeholder="118">
              <small class="text-muted">e.g., 118 = £1.18</small>
            </div>
            <div class="form-group">
              <label for="charityCreditPricePence">Charity Credit Price (pence)</label>
              <input type="number" id="charityCreditPricePence" class="form-input" min="0" required placeholder="59">
              <small class="text-muted">e.g., 59 = £0.59 (50% off)</small>
            </div>
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <input type="text" id="description" class="form-input" placeholder="Brief description of this tier">
          </div>

          <h4 style="margin: 20px 0 12px 0; font-size: 0.875rem; color: var(--gray-600);">Features</h4>

          <div class="grid grid-2">
            <div class="form-group">
              <label for="maxConcurrentSessions">Max Concurrent Sessions</label>
              <input type="number" id="maxConcurrentSessions" class="form-input" min="1" required placeholder="1">
            </div>
            <div class="form-group">
              <label for="displayOrder">Display Order</label>
              <input type="number" id="displayOrder" class="form-input" min="0" placeholder="1">
            </div>
          </div>

          <div class="grid grid-2" style="margin-top: 12px;">
            <div class="form-group">
              <label>
                <input type="checkbox" id="canCustomizeBranding">
                Custom Branding
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="canReceiveFeedback">
                Participant Feedback
              </label>
            </div>
          </div>

          <div class="grid grid-2">
            <div class="form-group">
              <label>
                <input type="checkbox" id="aiAudioEnabled">
                AI Audio
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="isActive" checked>
                Active (visible to customers)
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Format currency from pence
    function formatPence(pence) {
      return new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: 'GBP'
      }).format(pence / 100);
    }

    // Load pricing tiers
    async function loadTiers() {
      try {
        const response = await fetch('/api/pricing');
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const grid = document.getElementById('tiersGrid');
        if (data.data.length === 0) {
          grid.innerHTML = '<div class="tier-card"><p class="text-muted text-center">No pricing tiers found.</p></div>';
        } else {
          grid.innerHTML = data.data.map(tier => `
            <div class="tier-card ${tier.is_active ? '' : 'inactive'}">
              <div class="tier-header">
                <div>
                  <div class="tier-name">${tier.name}</div>
                  <div class="tier-id">${tier.id}</div>
                </div>
                <div class="tier-price">
                  ${formatPence(tier.monthly_fee_pence)}<small>/mo</small>
                </div>
              </div>

              <div class="tier-details">
                <div class="tier-detail">
                  <label>Credit Price</label>
                  <span>${formatPence(tier.credit_price_pence)}</span>
                </div>
                <div class="tier-detail">
                  <label>Charity Price</label>
                  <span>${formatPence(tier.charity_credit_price_pence)}</span>
                </div>
                <div class="tier-detail">
                  <label>Chars/Credit</label>
                  <span>${tier.chars_per_credit.toLocaleString()}</span>
                </div>
                <div class="tier-detail">
                  <label>Max Sessions</label>
                  <span>${tier.max_concurrent_sessions}</span>
                </div>
              </div>

              <div class="tier-features">
                <h4>Features</h4>
                <div class="feature-item ${tier.can_customize_branding ? 'enabled' : 'disabled'}">
                  ${tier.can_customize_branding ? '✓' : '✗'} Custom Branding
                </div>
                <div class="feature-item ${tier.can_receive_feedback ? 'enabled' : 'disabled'}">
                  ${tier.can_receive_feedback ? '✓' : '✗'} Participant Feedback
                </div>
                <div class="feature-item ${tier.ai_audio_enabled ? 'enabled' : 'disabled'}">
                  ${tier.ai_audio_enabled ? '✓' : '✗'} AI Audio
                </div>
              </div>

              <div class="tier-actions">
                <button class="btn btn-sm btn-outline" onclick="editTier('${tier.id}')">Edit</button>
                ${tier.is_active
                  ? `<button class="btn btn-sm btn-danger" onclick="disableTier('${tier.id}')">Disable</button>`
                  : `<span class="badge badge-gray">Inactive</span>`
                }
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading tiers:', error);
        document.getElementById('tiersGrid').innerHTML =
          '<div class="tier-card"><p class="text-danger text-center">Error loading pricing tiers</p></div>';
      }
    }

    // Load charity discount
    async function loadCharityDiscount() {
      try {
        const response = await fetch('/api/pricing');
        const data = await response.json();

        if (data.success && data.data.length > 0) {
          const tier = data.data[0];
          const discount = Math.round((1 - tier.charity_credit_price_pence / tier.credit_price_pence) * 100);
          document.getElementById('charityDiscount').textContent = `${discount}%`;
        }
      } catch (error) {
        console.error('Error loading charity discount:', error);
      }
    }

    // Edit tier
    async function editTier(id) {
      try {
        const response = await fetch(`/api/pricing/${id}`);
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const tier = data.data;
        document.getElementById('editModalTitle').textContent = 'Edit Pricing Tier';
        document.getElementById('tierId').value = tier.id;
        document.getElementById('isNewTier').value = 'false';
        document.getElementById('tierIdInput').value = tier.id;
        document.getElementById('tierIdInput').disabled = true;
        document.getElementById('tierName').value = tier.name || '';
        document.getElementById('monthlyFeePence').value = tier.monthly_fee_pence || 0;
        document.getElementById('charsPerCredit').value = tier.chars_per_credit || 23000;
        document.getElementById('creditPricePence').value = tier.credit_price_pence || 118;
        document.getElementById('charityCreditPricePence').value = tier.charity_credit_price_pence || 59;
        document.getElementById('maxConcurrentSessions').value = tier.max_concurrent_sessions || 1;
        document.getElementById('displayOrder').value = tier.display_order || 0;
        document.getElementById('description').value = tier.description || '';
        document.getElementById('canCustomizeBranding').checked = tier.can_customize_branding || false;
        document.getElementById('canReceiveFeedback').checked = tier.can_receive_feedback || false;
        document.getElementById('aiAudioEnabled').checked = tier.ai_audio_enabled || false;
        document.getElementById('isActive').checked = tier.is_active;
        document.getElementById('editModal').classList.add('active');
      } catch (error) {
        alert('Error loading tier: ' + error.message);
      }
    }

    // Save tier
    async function saveTier(event) {
      event.preventDefault();

      const isNew = document.getElementById('isNewTier').value === 'true';
      const id = isNew ? document.getElementById('tierIdInput').value : document.getElementById('tierId').value;

      const tier = {
        id: document.getElementById('tierIdInput').value,
        name: document.getElementById('tierName').value,
        monthlyFeePence: parseInt(document.getElementById('monthlyFeePence').value),
        charsPerCredit: parseInt(document.getElementById('charsPerCredit').value),
        creditPricePence: parseInt(document.getElementById('creditPricePence').value),
        charityCreditPricePence: parseInt(document.getElementById('charityCreditPricePence').value),
        maxConcurrentSessions: parseInt(document.getElementById('maxConcurrentSessions').value),
        displayOrder: parseInt(document.getElementById('displayOrder').value) || 0,
        description: document.getElementById('description').value,
        canCustomizeBranding: document.getElementById('canCustomizeBranding').checked,
        canReceiveFeedback: document.getElementById('canReceiveFeedback').checked,
        aiAudioEnabled: document.getElementById('aiAudioEnabled').checked,
        isActive: document.getElementById('isActive').checked,
      };

      try {
        const url = isNew ? '/api/pricing' : `/api/pricing/${id}`;
        const method = isNew ? 'POST' : 'PUT';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(tier),
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert(data.message);
        closeEditModal();
        loadTiers();
        loadCharityDiscount();
      } catch (error) {
        alert('Error saving tier: ' + error.message);
      }
    }

    // Disable tier
    async function disableTier(id) {
      if (!confirm('Are you sure you want to disable this pricing tier?')) return;

      try {
        const response = await fetch(`/api/pricing/${id}`, {
          method: 'DELETE',
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert(data.message);
        loadTiers();
      } catch (error) {
        alert('Error disabling tier: ' + error.message);
      }
    }

    // Close modal
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/login';
      } catch (error) {
        console.error('Logout error:', error);
      }
    }

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadTiers();
      loadCharityDiscount();
    });
  </script>
</body>
</html>
