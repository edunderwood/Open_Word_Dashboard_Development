<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customers - Open Word Admin</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>Open Word</h1>
        <p>Admin Dashboard</p>
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li>
            <a href="/dashboard">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
              </svg>
              Dashboard
            </a>
          </li>
          <li>
            <a href="/customers" class="active">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
              Customers
            </a>
          </li>
          <li>
            <a href="/pricing">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Pricing
            </a>
          </li>
          <li>
            <a href="/price-migration">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
              </svg>
              Price Migration
            </a>
          </li>
          <li>
            <a href="/costs">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Costs
            </a>
          </li>
          <li>
            <a href="/charity-registers">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              Charity Registers
            </a>
          </li>
          <li>
            <a href="/communications">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              Communications
            </a>
          </li>
          <li>
            <a href="/monitoring">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              Monitoring
            </a>
          </li>
          <li>
            <a href="/analytics">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
              </svg>
              Analytics
            </a>
          </li>
        </ul>
      </nav>
      <div class="sidebar-footer">
        <button onclick="logout()">Sign Out</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h2>Customers</h2>
        <p>Manage all Open Word customers</p>
      </div>

      <!-- Search and Filters -->
      <div class="card">
        <div class="search-bar">
          <div style="display: flex; gap: 8px; flex: 1; max-width: 400px;">
            <input
              type="text"
              id="searchInput"
              class="form-input"
              placeholder="Search customer name or key..."
              onkeyup="handleSearch(event)"
              style="flex: 1;"
            >
            <button class="btn btn-primary" onclick="loadCustomers()" style="white-space: nowrap;">
              Search
            </button>
          </div>
          <select id="statusFilter" class="form-input" style="width: auto;" onchange="loadCustomers()">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="trialing">Trial</option>
            <option value="paused">Paused</option>
            <option value="past_due">Past Due</option>
            <option value="unpaid">Unpaid</option>
            <option value="canceled">Cancelled</option>
          </select>
          <select id="planFilter" class="form-input" style="width: auto;" onchange="loadCustomers()">
            <option value="">All Tiers</option>
            <option value="basic">Basic</option>
            <option value="standard">Standard</option>
            <option value="pro">Pro</option>
            <option value="enterprise">Enterprise</option>
          </select>
          <select id="charityFilter" class="form-input" style="width: auto;" onchange="loadCustomers()">
            <option value="">All Discount Status</option>
            <option value="verified">Verified Charities</option>
            <option value="discounted">Has Discount (Non-Charity)</option>
            <option value="discount_pending">Discount Request Pending</option>
            <option value="pending">Charity Review Pending</option>
            <option value="claimed">Claims Charity</option>
            <option value="none">No Discount</option>
          </select>
        </div>
      </div>

      <!-- Customer Table -->
      <div class="card">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Organisation</th>
                <th>Key</th>
                <th>Tier</th>
                <th>Discount</th>
                <th>Credits</th>
                <th>Status</th>
                <th>Last Login</th>
                <th>Trial Ends</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="customersTable">
              <tr><td colspan="9" class="text-center text-muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination">
          <div class="pagination-info" id="paginationInfo">Showing 0 of 0</div>
          <div class="pagination-buttons">
            <button class="btn btn-sm btn-outline" id="prevBtn" onclick="prevPage()" disabled>Previous</button>
            <button class="btn btn-sm btn-outline" id="nextBtn" onclick="nextPage()" disabled>Next</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Customer Detail Modal -->
  <div class="modal-overlay" id="customerModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="modalTitle">Customer Details</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        Loading...
      </div>
      <div class="modal-footer" id="modalFooter">
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Email Customer Modal -->
  <div class="modal-overlay" id="emailModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3 id="emailModalTitle">Email Customer</h3>
        <button class="modal-close" onclick="closeEmailModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="emailTo">To:</label>
          <input type="text" id="emailTo" class="form-input" readonly style="background: var(--gray-100);">
        </div>
        <div class="form-group">
          <label for="emailSubject">Subject: *</label>
          <input type="text" id="emailSubject" class="form-input" placeholder="Enter email subject...">
        </div>
        <div class="form-group">
          <label for="emailBody">Message: *</label>
          <textarea id="emailBody" class="form-input" rows="10" placeholder="Enter your message..."></textarea>
        </div>
        <input type="hidden" id="emailCustomerId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEmailModal()">Cancel</button>
        <button class="btn btn-primary" onclick="sendCustomerEmail()">Send Email</button>
      </div>
    </div>
  </div>

  <!-- Usage Modal -->
  <div class="modal-overlay" id="usageModal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3 id="usageModalTitle">Customer Usage</h3>
        <button class="modal-close" onclick="closeUsageModal()">&times;</button>
      </div>
      <div class="modal-body" id="usageModalBody">
        Loading...
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeUsageModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Discount Modal -->
  <div class="modal-overlay" id="discountModal">
    <div class="modal" style="max-width: 450px;">
      <div class="modal-header">
        <h3 id="discountModalTitle">Set Discount</h3>
        <button class="modal-close" onclick="closeDiscountModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p id="discountModalCustomerName" style="margin-bottom: 16px; color: var(--gray-600);"></p>

        <div class="form-group">
          <label for="discountPercentSelect">Discount Percentage: *</label>
          <select id="discountPercentSelect" class="form-input" style="width: 100%; padding: 10px; font-size: 14px;">
            <option value="">Select percentage...</option>
            <option value="10">10%</option>
            <option value="20">20%</option>
            <option value="30">30%</option>
            <option value="40">40%</option>
            <option value="50">50%</option>
          </select>
        </div>

        <div class="form-group">
          <label for="discountTypeSelect">Discount Type: *</label>
          <select id="discountTypeSelect" class="form-input" style="width: 100%; padding: 10px; font-size: 14px;">
            <option value="">Select type...</option>
            <option value="charity">Charity - Registered charity</option>
            <option value="church">Church - Church or religious organisation</option>
            <option value="nonprofit">Nonprofit - Non-profit organisation</option>
            <option value="educational">Educational - Educational institution</option>
            <option value="community">Community - Community organisation</option>
            <option value="partner">Partner - Partnership agreement</option>
            <option value="promotional">Promotional - Promotional offer</option>
            <option value="negotiated">Negotiated - Negotiated rate</option>
            <option value="other">Other - Other reason</option>
          </select>
        </div>

        <div class="form-group">
          <label for="discountReasonInput">Reason (optional):</label>
          <input type="text" id="discountReasonInput" class="form-input" placeholder="Enter reason for discount..." style="width: 100%;">
        </div>

        <input type="hidden" id="discountCustomerId">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDiscountModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitDiscount()">Apply Discount</button>
      </div>
    </div>
  </div>

  <script>
    let currentPage = 1;
    let totalPages = 1;
    let searchTimeout = null;

    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-GB', {
        style: 'currency',
        currency: 'GBP'
      }).format(amount);
    }

    // Format number
    function formatNumber(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      }
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toLocaleString();
    }

    // Format date
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });
    }

    // Get tier color
    function getTierColor(tier) {
      const colors = {
        basic: '#6b7280',
        standard: '#3b82f6',
        pro: '#f59e0b',
        enterprise: '#8b5cf6'
      };
      return colors[tier] || colors.basic;
    }

    // Get status badge (for subscription_status - legacy)
    function getStatusBadge(customer) {
      if (customer.is_paused) {
        return '<span class="badge badge-warning">Paused</span>';
      }
      const status = customer.subscription_status;
      const badges = {
        active: '<span class="badge badge-success">Active</span>',
        trialing: '<span class="badge badge-info">Trial</span>',
        past_due: '<span class="badge badge-warning">Past Due</span>',
        unpaid: '<span class="badge badge-danger">Unpaid</span>',
        canceled: '<span class="badge badge-gray">Cancelled</span>',
      };
      return badges[status] || `<span class="badge badge-gray">${status || 'Unknown'}</span>`;
    }

    // Get payment status badge (for payment_status field)
    function getPaymentStatusBadge(customer) {
      if (customer.is_paused) {
        return '<span class="badge badge-warning">Paused</span>';
      }
      const status = customer.payment_status;
      const badges = {
        paid: '<span class="badge badge-success">Paid</span>',
        pending: '<span class="badge badge-warning">Pending</span>',
        failed: '<span class="badge badge-danger">Failed</span>',
      };
      return badges[status] || `<span class="badge badge-gray">${status || 'Unknown'}</span>`;
    }

    // Handle search with debounce
    function handleSearch(event) {
      clearTimeout(searchTimeout);
      if (event.key === 'Enter') {
        loadCustomers();
      } else {
        searchTimeout = setTimeout(() => {
          loadCustomers();
        }, 500);
      }
    }

    // Load customers
    async function loadCustomers() {
      const search = document.getElementById('searchInput').value;
      const status = document.getElementById('statusFilter').value;
      const plan = document.getElementById('planFilter').value;
      const charity = document.getElementById('charityFilter').value;

      try {
        const params = new URLSearchParams({
          page: currentPage,
          limit: 20,
        });
        if (search) params.append('search', search);
        if (status) params.append('status', status);
        if (plan) params.append('plan', plan);
        if (charity) params.append('charity', charity);

        const response = await fetch(`/api/customers?${params}`);
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const { data: customers, pagination } = data;
        totalPages = pagination.pages;

        // Update table
        const table = document.getElementById('customersTable');
        if (customers.length === 0) {
          table.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No customers found</td></tr>';
        } else {
          table.innerHTML = customers.map(customer => {
            const creditBalance = customer.credit_balance ?? 0;
            const tier = customer.subscription_tier || 'basic';
            // Discount display
            const discountDisplay = customer.discount_percent > 0
              ? `<span class="badge" style="background: ${customer.charity_verified ? '#10b981' : '#2563eb'}; color: white;">${customer.discount_percent}%</span>`
              : customer.discount_review_requested
                ? '<span class="badge badge-warning" style="font-size: 9px;">Pending</span>'
                : '<span class="text-muted">-</span>';
            return `
            <tr>
              <td>
                <strong>${customer.name || 'Unnamed'}</strong>
                ${customer.charity_verified
                  ? '<span class="badge badge-success" style="margin-left: 4px; font-size: 9px;">Charity</span>'
                  : customer.charity_review_requested
                    ? '<span class="badge badge-warning" style="margin-left: 4px; font-size: 9px;">Charity Review</span>'
                    : ''
                }
              </td>
              <td><code>${customer.organisation_key || '-'}</code></td>
              <td><span class="badge" style="background: ${getTierColor(tier)}; color: white;">${tier.charAt(0).toUpperCase() + tier.slice(1)}</span></td>
              <td>${discountDisplay}</td>
              <td style="font-weight: 600; color: ${creditBalance <= 0 ? 'var(--danger)' : creditBalance <= 10 ? 'var(--warning)' : 'inherit'};">
                ${creditBalance.toFixed(1)}
              </td>
              <td>${getPaymentStatusBadge(customer)}</td>
              <td>${customer.last_login ? formatDateTime(customer.last_login) : '<span class="text-muted">Never</span>'}</td>
              <td>${customer.trial_ends_at ? formatDate(customer.trial_ends_at) : '<span class="text-muted">-</span>'}</td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="viewCustomer('${customer.id}')">View/Edit</button>
                ${customer.is_paused
                  ? `<button class="btn btn-sm btn-success" onclick="unpauseCustomer('${customer.id}')">Unpause</button>`
                  : `<button class="btn btn-sm btn-warning" onclick="pauseCustomer('${customer.id}')">Pause</button>`
                }
              </td>
            </tr>
          `}).join('');
        }

        // Update pagination
        document.getElementById('paginationInfo').textContent =
          `Showing ${customers.length} of ${pagination.total} (Page ${pagination.page} of ${pagination.pages})`;
        document.getElementById('prevBtn').disabled = pagination.page <= 1;
        document.getElementById('nextBtn').disabled = pagination.page >= pagination.pages;
      } catch (error) {
        console.error('Error loading customers:', error);
        document.getElementById('customersTable').innerHTML =
          '<tr><td colspan="9" class="text-center text-danger">Error loading customers</td></tr>';
      }
    }

    // Pagination
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        loadCustomers();
      }
    }

    function nextPage() {
      if (currentPage < totalPages) {
        currentPage++;
        loadCustomers();
      }
    }

    // Format date with time
    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // View customer details
    async function viewCustomer(id) {
      document.getElementById('customerModal').classList.add('active');
      document.getElementById('modalBody').innerHTML = '<div class="text-center"><div class="spinner"></div></div>';

      try {
        // Fetch customer details, session stats, and credits in parallel
        const [customerResponse, sessionResponse, creditsResponse] = await Promise.all([
          fetch(`/api/customers/${id}`),
          fetch(`/api/customers/${id}/session-stats`),
          fetch(`/api/customers/${id}/credits`)
        ]);

        const customerData = await customerResponse.json();
        const sessionData = await sessionResponse.json();
        const creditsData = await creditsResponse.json();

        if (!customerData.success) throw new Error(customerData.error);

        const customer = customerData.data;
        const sessionStats = sessionData.success ? sessionData.data : null;
        const credits = creditsData.success ? creditsData.data : null;

        document.getElementById('modalTitle').textContent = customer.name || 'Customer Details';

        document.getElementById('modalBody').innerHTML = `
          <div class="grid grid-2" style="gap: 30px;">
            <div>
              <h4 style="margin-bottom: 15px; color: var(--gray-500); font-size: 0.75rem; text-transform: uppercase;">Organisation Info</h4>
              <p><strong>Name:</strong> ${customer.name || '-'}</p>
              <p><strong>Key:</strong> <code>${customer.organisation_key || '-'}</code></p>
              <p><strong>Created:</strong> ${formatDate(customer.created_at)}</p>
              <p><strong>User ID:</strong> <code style="font-size: 0.75rem;">${customer.user_id || '-'}</code></p>
            </div>
            <div>
              <h4 style="margin-bottom: 15px; color: var(--gray-500); font-size: 0.75rem; text-transform: uppercase;">Subscription</h4>
              <p><strong>Plan:</strong> ${(customer.subscription_tier || '-').replace(/_/g, ' ')}</p>
              <p><strong>Status:</strong> ${getPaymentStatusBadge(customer)}</p>
              <p><strong>Stripe Customer:</strong> <code style="font-size: 0.75rem;">${customer.stripe_customer_id || '-'}</code></p>
              ${customer.trial_ends_at ? `<p><strong>Trial Ends:</strong> ${formatDate(customer.trial_ends_at)}</p>` : ''}
            </div>
          </div>

          <!-- Activity Stats Section -->
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gray-200);">
            <h4 style="margin-bottom: 15px; color: var(--gray-500); font-size: 0.75rem; text-transform: uppercase;">Activity & Streaming Stats</h4>
            <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); gap: 15px;">
              <div class="stat-card" style="padding: 15px;">
                <div class="label" style="font-size: 0.7rem;">Last Login</div>
                <div class="value" style="font-size: 0.9rem;">${sessionStats?.lastLogin ? formatDateTime(sessionStats.lastLogin) : 'Never'}</div>
              </div>
              <div class="stat-card" style="padding: 15px;">
                <div class="label" style="font-size: 0.7rem;">Last Streaming Session</div>
                <div class="value" style="font-size: 0.9rem;">${sessionStats?.lastStreamingSession?.startedAt ? formatDateTime(sessionStats.lastStreamingSession.startedAt) : 'Never'}</div>
                ${sessionStats?.lastStreamingSession?.status === 'active' ? '<span class="badge badge-success" style="margin-top: 5px;">Currently Active</span>' : ''}
              </div>
              <div class="stat-card" style="padding: 15px;">
                <div class="label" style="font-size: 0.7rem;">Avg Session (Last 10)</div>
                <div class="value" style="font-size: 0.9rem;">${sessionStats?.sessionStats?.avgSessionDurationFormatted || '0 min'}</div>
                <div style="font-size: 0.7rem; color: var(--gray-500);">${sessionStats?.sessionStats?.totalSessions || 0} total sessions</div>
              </div>
            </div>
            ${sessionStats?.sessionStats?.last10Sessions?.length > 0 ? `
              <div style="margin-top: 15px;">
                <h5 style="margin-bottom: 10px; color: var(--gray-500); font-size: 0.7rem; text-transform: uppercase;">Recent Sessions</h5>
                <div class="table-container" style="max-height: 150px; overflow-y: auto;">
                  <table style="font-size: 0.85rem;">
                    <thead>
                      <tr>
                        <th>Started</th>
                        <th>Ended</th>
                        <th>Duration</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${sessionStats.sessionStats.last10Sessions.map(s => `
                        <tr>
                          <td>${formatDateTime(s.startedAt)}</td>
                          <td>${formatDateTime(s.endedAt)}</td>
                          <td><strong>${s.durationFormatted}</strong></td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            ` : ''}
          </div>

          <!-- Discounts Section (combines charity and non-charity discounts) -->
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gray-200);">
            <h4 style="margin-bottom: 15px; color: var(--gray-500); font-size: 0.75rem; text-transform: uppercase;">Discounts</h4>

            <!-- Current Discount Status -->
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;">
              ${customer.charity_verified
                ? `<span class="badge badge-success" style="font-size: 12px; padding: 6px 12px;">Charity ${customer.charity_discount_percent || 50}% Discount</span>`
                : customer.discount_percent > 0
                  ? `<span class="badge" style="font-size: 12px; padding: 6px 12px; background: #2563eb; color: white;">${customer.discount_type ? customer.discount_type.charAt(0).toUpperCase() + customer.discount_type.slice(1) : 'General'} ${customer.discount_percent}% Discount</span>`
                  : customer.discount_review_requested
                    ? '<span class="badge badge-warning" style="font-size: 12px; padding: 6px 12px;">Discount Request Pending</span>'
                    : '<span class="badge badge-gray" style="font-size: 12px; padding: 6px 12px;">No Discount</span>'
              }
            </div>

            <!-- Pending Discount Request -->
            ${customer.discount_review_requested && customer.discount_percent === 0 ? `
              <div style="background: #fef3c7; border: 1px solid #f59e0b; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #92400e;">Discount Request Pending</div>
                <div style="font-size: 0.85rem; color: #78350f;">
                  ${customer.discount_review_reason ? `<div style="margin-bottom: 8px;"><strong>Reason:</strong> ${customer.discount_review_reason}</div>` : '<div style="margin-bottom: 8px;">No reason provided</div>'}
                  ${customer.discount_review_requested_at ? `<div><strong>Requested:</strong> ${formatDate(customer.discount_review_requested_at)}</div>` : ''}
                </div>
                <div style="margin-top: 10px; display: flex; gap: 8px;">
                  <button class="btn btn-sm btn-success" onclick="setDiscount('${customer.id}', '${(customer.name || '').replace(/'/g, "\\'")}')">Approve & Set Discount</button>
                  <button class="btn btn-sm btn-outline" style="color: #dc2626; border-color: #dc2626;" onclick="denyDiscountRequest('${customer.id}', '${(customer.name || '').replace(/'/g, "\\'")}')">Deny Request</button>
                </div>
              </div>
            ` : ''}

            <!-- Non-charity discount details -->
            ${!customer.charity_verified && customer.discount_percent > 0 ? `
              <div style="background: #eff6ff; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.85rem;">
                  <div><strong>Type:</strong> ${customer.discount_type || 'N/A'}</div>
                  <div><strong>Amount:</strong> ${customer.discount_percent}%</div>
                  ${customer.discount_reason ? `<div style="grid-column: span 2;"><strong>Reason:</strong> ${customer.discount_reason}</div>` : ''}
                  ${customer.discount_approved_at ? `<div><strong>Approved:</strong> ${formatDate(customer.discount_approved_at)}</div>` : ''}
                  ${customer.discount_approved_by ? `<div><strong>By:</strong> ${customer.discount_approved_by}</div>` : ''}
                </div>
              </div>
            ` : ''}

            <!-- Charity Status (if applicable) -->
            ${customer.is_charity || customer.charity_verified || customer.charity_review_requested ? `
              <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                <div style="font-weight: 600; margin-bottom: 8px;">Charity Status</div>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; font-size: 0.85rem;">
                  ${customer.charity_verified
                    ? '<span class="badge badge-success">Verified</span>'
                    : customer.charity_review_requested
                      ? '<span class="badge badge-warning">Review Pending</span>'
                      : '<span class="badge badge-info">Claims Charity (Unverified)</span>'
                  }
                  ${customer.charity_number ? `<span><strong>No:</strong> ${customer.charity_number}</span>` : ''}
                  ${customer.charity_region ? `<span><strong>Region:</strong> ${customer.charity_region}</span>` : ''}
                </div>
                ${customer.charity_review_notes ? `<div style="margin-top: 8px; font-size: 0.8rem; color: var(--gray-500);"><strong>Notes:</strong> ${customer.charity_review_notes}</div>` : ''}
              </div>
            ` : ''}

            <!-- Discount Actions -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              ${!customer.charity_verified ? `
                <!-- Non-charity discount actions -->
                ${customer.discount_percent > 0
                  ? `<button class="btn btn-sm btn-warning" onclick="removeDiscount('${customer.id}', '${(customer.name || '').replace(/'/g, "\\'")}')">Remove Discount</button>
                     <button class="btn btn-sm btn-outline" onclick="setDiscount('${customer.id}', '${(customer.name || '').replace(/'/g, "\\'")}')">Change Discount</button>`
                  : `<button class="btn btn-sm" style="background: #2563eb; color: white;" onclick="setDiscount('${customer.id}', '${(customer.name || '').replace(/'/g, "\\'")}')">Set Discount</button>`
                }
              ` : ''}

              <!-- Charity discount actions -->
              ${!customer.charity_verified
                ? `<button class="btn btn-sm btn-success" onclick="grantCharityDiscount('${customer.id}', '${(customer.name || '').replace(/'/g, "\\'")}')">Grant Charity Discount</button>`
                : `<button class="btn btn-sm btn-danger" onclick="revokeCharityDiscount('${customer.id}', '${(customer.name || '').replace(/'/g, "\\'")}')">Revoke Charity Discount</button>`
              }
              ${customer.charity_review_requested && !customer.charity_verified
                ? `<button class="btn btn-sm btn-outline" style="color: #dc2626; border-color: #dc2626;" onclick="denyCharityReview('${customer.id}', '${(customer.name || '').replace(/'/g, "\\'")}')">Deny Review</button>`
                : ''
              }
            </div>
          </div>

          <!-- Credit Balance Section -->
          <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gray-200);">
            <h4 style="margin-bottom: 15px; color: var(--gray-500); font-size: 0.75rem; text-transform: uppercase;">
              Credit Balance
              ${customer.charity_verified ? `<span class="badge badge-success" style="margin-left: 8px;">${customer.charity_discount_percent || 50}% Charity Discount</span>` : ''}
            </h4>
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); gap: 15px;">
              <div class="stat-card" style="padding: 15px; ${credits?.balance?.current <= 10 ? 'border: 2px solid var(--danger);' : ''}">
                <div class="label" style="font-size: 0.7rem;">Current Balance</div>
                <div class="value" style="font-size: 1.2rem; color: ${credits?.balance?.current <= 0 ? 'var(--danger)' : credits?.balance?.current <= 10 ? 'var(--warning)' : 'var(--success)'};">
                  ${credits?.balance?.current?.toFixed(2) || '0.00'} credits
                </div>
              </div>
              <div class="stat-card" style="padding: 15px;">
                <div class="label" style="font-size: 0.7rem;">Tier</div>
                <div class="value" style="font-size: 1.2rem;">
                  <span class="badge" style="background: ${getTierColor(credits?.tier || 'basic')}; color: white;">${(credits?.tier || 'basic').charAt(0).toUpperCase() + (credits?.tier || 'basic').slice(1)}</span>
                </div>
              </div>
              <div class="stat-card" style="padding: 15px;">
                <div class="label" style="font-size: 0.7rem;">Lifetime Purchased</div>
                <div class="value" style="font-size: 1rem;">${credits?.balance?.purchased?.toFixed(2) || '0.00'}</div>
              </div>
              <div class="stat-card" style="padding: 15px;">
                <div class="label" style="font-size: 0.7rem;">Lifetime Used</div>
                <div class="value" style="font-size: 1rem;">${credits?.balance?.used?.toFixed(2) || '0.00'}</div>
              </div>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
              <button class="btn btn-sm btn-success" onclick="addCredits('${customer.id}', '${customer.name}')">Gift Credits</button>
              <button class="btn btn-sm btn-warning" onclick="deductCredits('${customer.id}', '${customer.name}')">Deduct Credits</button>
            </div>
            ${credits?.recentUsage?.length > 0 ? `
              <div style="margin-top: 15px;">
                <h5 style="margin-bottom: 10px; color: var(--gray-500); font-size: 0.7rem; text-transform: uppercase;">Recent Credit Usage</h5>
                <div class="table-container" style="max-height: 120px; overflow-y: auto;">
                  <table style="font-size: 0.85rem;">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Credits Used</th>
                        <th>Characters</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${credits.recentUsage.map(u => `
                        <tr>
                          <td>${formatDateTime(u.session_start)}</td>
                          <td style="color: var(--danger);">-${parseFloat(u.credits_used).toFixed(3)}</td>
                          <td>${formatNumber(u.total_billable_characters)}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            ` : ''}
          </div>

          ${customer.stripe ? `
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gray-200);">
              <h4 style="margin-bottom: 15px; color: var(--gray-500); font-size: 0.75rem; text-transform: uppercase;">Stripe Details</h4>
              <div class="grid grid-2">
                <p><strong>Period:</strong> ${formatDate(customer.stripe.currentPeriodStart)} - ${formatDate(customer.stripe.currentPeriodEnd)}</p>
                <p><strong>Cancel at Period End:</strong> ${customer.stripe.cancelAtPeriodEnd ? 'Yes' : 'No'}</p>
                ${customer.stripe.trialEnd ? `<p><strong>Trial End:</strong> ${formatDate(customer.stripe.trialEnd)}</p>` : ''}
              </div>
            </div>
          ` : ''}
          ${customer.is_paused ? `
            <div class="alert alert-warning mt-4">
              <strong>Account Paused</strong>
              <p style="margin-top: 5px;">Paused on: ${formatDate(customer.paused_at)}</p>
              <p>Reason: ${customer.pause_reason || 'No reason provided'}</p>
            </div>
          ` : ''}
        `;

        // Update footer with actions - left side for dangerous actions, right side for close
        const leftButtons = [];
        if (customer.subscription_status === 'trialing') {
          leftButtons.push(`<button class="btn btn-warning" onclick="endTrial('${customer.id}')">End Trial</button>`);
        }
        if (customer.stripe_subscription_id && customer.subscription_status === 'active') {
          leftButtons.push(`<button class="btn btn-danger" onclick="cancelSubscription('${customer.id}')">Cancel Subscription</button>`);
        }

        document.getElementById('modalFooter').innerHTML = `
          <div style="display: flex; gap: 12px;">
            ${leftButtons.join('')}
          </div>
          <div style="display: flex; gap: 12px;">
            <button class="btn btn-primary" onclick="emailCustomer('${customer.id}', '${(customer.name || '').replace(/'/g, "\\'")}')">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
              Email Customer
            </button>
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
          </div>
        `;
        document.getElementById('modalFooter').style.justifyContent = 'space-between';
      } catch (error) {
        console.error('Error loading customer:', error);
        document.getElementById('modalBody').innerHTML =
          `<div class="alert alert-danger">Error loading customer: ${error.message}</div>`;
      }
    }

    // View usage
    async function viewUsage(id, name) {
      document.getElementById('usageModal').classList.add('active');
      document.getElementById('usageModalTitle').textContent = `Usage: ${name || 'Customer'}`;
      document.getElementById('usageModalBody').innerHTML = '<div class="text-center"><div class="spinner"></div></div>';

      try {
        const response = await fetch(`/api/customers/${id}/usage?period=month`);
        const data = await response.json();

        if (!data.success) throw new Error(data.error);

        const usage = data.data;

        document.getElementById('usageModalBody').innerHTML = `
          <div class="stats-grid" style="margin-bottom: 20px;">
            <div class="stat-card">
              <div class="label">Total Characters</div>
              <div class="value">${formatNumber(usage.totalCharacters)}</div>
            </div>
            <div class="stat-card">
              <div class="label">Estimated Cost</div>
              <div class="value">${formatCurrency(usage.totalCost)}</div>
            </div>
            <div class="stat-card">
              <div class="label">Transcription</div>
              <div class="value">${formatNumber(usage.transcriptionChars)}</div>
            </div>
            <div class="stat-card">
              <div class="label">Translation</div>
              <div class="value">${formatNumber(usage.translationChars)}</div>
            </div>
          </div>

          <h4 style="margin-bottom: 15px; color: var(--gray-500); font-size: 0.75rem; text-transform: uppercase;">Usage by Language</h4>
          <div class="grid grid-3" style="margin-bottom: 20px;">
            ${Object.entries(usage.byLanguage).map(([lang, chars]) => `
              <div style="padding: 10px; background: var(--gray-50); border-radius: 8px;">
                <strong>${lang}</strong>: ${formatNumber(chars)}
              </div>
            `).join('') || '<div class="text-muted">No language data</div>'}
          </div>

          <h4 style="margin-bottom: 15px; color: var(--gray-500); font-size: 0.75rem; text-transform: uppercase;">Daily Usage</h4>
          <div class="table-container" style="max-height: 200px; overflow-y: auto;">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Characters</th>
                  <th>Cost</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(usage.byDate).sort((a, b) => b[0].localeCompare(a[0])).map(([date, data]) => `
                  <tr>
                    <td>${formatDate(date)}</td>
                    <td>${formatNumber(data.characters)}</td>
                    <td>${formatCurrency(data.cost)}</td>
                  </tr>
                `).join('') || '<tr><td colspan="3" class="text-center text-muted">No daily data</td></tr>'}
              </tbody>
            </table>
          </div>

          <div class="mt-4 text-muted text-center">
            Period: ${usage.period} | Records: ${usage.records}
          </div>
        `;
      } catch (error) {
        console.error('Error loading usage:', error);
        document.getElementById('usageModalBody').innerHTML =
          `<div class="alert alert-danger">Error loading usage: ${error.message}</div>`;
      }
    }

    // Pause customer
    async function pauseCustomer(id) {
      // First confirmation
      if (!confirm('Are you sure you want to PAUSE this customer?\n\nThis will temporarily suspend their access to the service.')) {
        return;
      }

      // Second confirmation
      if (!confirm('Please confirm again: PAUSE this customer account?\n\nClick OK to proceed or Cancel to abort.')) {
        return;
      }

      const reason = prompt('Enter reason for pausing (optional):');

      try {
        const response = await fetch(`/api/customers/${id}/pause`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason }),
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert('Customer paused successfully');
        loadCustomers();
      } catch (error) {
        alert('Error pausing customer: ' + error.message);
      }
    }

    // Unpause customer
    async function unpauseCustomer(id) {
      if (!confirm('Are you sure you want to unpause this customer?')) return;

      try {
        const response = await fetch(`/api/customers/${id}/unpause`, {
          method: 'POST',
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert('Customer unpaused successfully');
        loadCustomers();
      } catch (error) {
        alert('Error unpausing customer: ' + error.message);
      }
    }

    // End trial
    async function endTrial(id) {
      if (!confirm('Are you sure you want to end this customer\'s trial? They will be charged immediately.')) return;

      try {
        const response = await fetch(`/api/customers/${id}/end-trial`, {
          method: 'POST',
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert('Trial ended successfully. New status: ' + data.data.newStatus);
        closeModal();
        loadCustomers();
      } catch (error) {
        alert('Error ending trial: ' + error.message);
      }
    }

    // Cancel subscription
    async function cancelSubscription(id) {
      // First confirmation
      if (!confirm('Are you sure you want to CANCEL this subscription?\n\nThis action cannot be easily undone and will affect the customer\'s billing.')) {
        return;
      }

      // Second confirmation with type check
      const confirmText = prompt('To confirm cancellation, please type "CANCEL" (all caps):');
      if (confirmText !== 'CANCEL') {
        alert('Cancellation aborted. You must type "CANCEL" exactly to proceed.');
        return;
      }

      // Ask about timing
      const immediately = confirm('Cancel IMMEDIATELY?\n\n• Click OK to cancel immediately (customer loses access now)\n• Click Cancel to cancel at end of billing period (customer keeps access until then)');

      try {
        const response = await fetch(`/api/customers/${id}/cancel-subscription`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ immediately }),
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert(data.message);
        closeModal();
        loadCustomers();
      } catch (error) {
        alert('Error cancelling subscription: ' + error.message);
      }
    }

    // Add credits to customer (admin gift)
    async function addCredits(id, name) {
      const amountStr = prompt(`Enter the number of credits to gift to ${name}:`);
      if (!amountStr) return;

      const amount = parseFloat(amountStr);
      if (isNaN(amount) || amount <= 0) {
        alert('Please enter a valid positive number');
        return;
      }

      const reason = prompt('Enter a reason for this credit gift (optional):') || 'Admin gift';

      if (!confirm(`Gift ${amount} credits to ${name}?\n\nReason: ${reason}`)) return;

      try {
        const response = await fetch(`/api/customers/${id}/add-credits`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ credits: amount, reason }),
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert(`Successfully added ${amount} credits to ${name}.\nNew balance: ${data.data.newBalance.toFixed(2)} credits`);
        viewCustomer(id); // Refresh modal
      } catch (error) {
        alert('Error adding credits: ' + error.message);
      }
    }

    // Deduct credits from customer (admin adjustment)
    async function deductCredits(id, name) {
      const amountStr = prompt(`Enter the number of credits to deduct from ${name}:`);
      if (!amountStr) return;

      const amount = parseFloat(amountStr);
      if (isNaN(amount) || amount <= 0) {
        alert('Please enter a valid positive number');
        return;
      }

      const reason = prompt('Enter a reason for this deduction (required):');
      if (!reason) {
        alert('A reason is required for deductions');
        return;
      }

      if (!confirm(`Deduct ${amount} credits from ${name}?\n\nReason: ${reason}\n\nThis action cannot be easily undone.`)) return;

      try {
        const response = await fetch(`/api/customers/${id}/deduct-credits`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ credits: amount, reason }),
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert(`Successfully deducted ${amount} credits from ${name}.\nNew balance: ${data.data.newBalance.toFixed(2)} credits`);
        viewCustomer(id); // Refresh modal
      } catch (error) {
        alert('Error deducting credits: ' + error.message);
      }
    }

    // Set non-charity discount - opens modal with dropdowns
    function setDiscount(id, name) {
      document.getElementById('discountCustomerId').value = id;
      document.getElementById('discountModalCustomerName').textContent = `Setting discount for: ${name}`;
      document.getElementById('discountModalTitle').textContent = 'Set Discount';

      // Reset form
      document.getElementById('discountPercentSelect').value = '';
      document.getElementById('discountTypeSelect').value = '';
      document.getElementById('discountReasonInput').value = '';

      // Show modal
      document.getElementById('discountModal').classList.add('active');
    }

    function closeDiscountModal() {
      document.getElementById('discountModal').classList.remove('active');
    }

    async function submitDiscount() {
      const id = document.getElementById('discountCustomerId').value;
      const percent = parseInt(document.getElementById('discountPercentSelect').value);
      const discountType = document.getElementById('discountTypeSelect').value;
      const reason = document.getElementById('discountReasonInput').value.trim();

      // Validate
      if (!percent) {
        alert('Please select a discount percentage.');
        return;
      }
      if (!discountType) {
        alert('Please select a discount type.');
        return;
      }

      const typeLabel = document.getElementById('discountTypeSelect').options[document.getElementById('discountTypeSelect').selectedIndex].text;

      try {
        const response = await fetch(`/api/customers/${id}/set-discount`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ discountPercent: percent, discountType, reason })
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        closeDiscountModal();

        // Show success with Stripe sync status
        let message = `${percent}% discount applied successfully.`;
        if (data.stripeCouponApplied) {
          message += '\n\nStripe subscription updated with discount.';
        } else if (data.stripeMessage) {
          message += `\n\nNote: Stripe not updated - ${data.stripeMessage}`;
        }
        alert(message);

        viewCustomer(id); // Refresh modal
        loadCustomers(); // Refresh list
      } catch (error) {
        alert('Error setting discount: ' + error.message);
      }
    }

    // Remove non-charity discount
    async function removeDiscount(id, name) {
      if (!confirm(`Remove discount from "${name}"?\n\nThey will no longer receive discounted pricing.`)) return;

      const reason = prompt('Enter reason for removing discount (optional):');

      try {
        const response = await fetch(`/api/customers/${id}/remove-discount`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert(`Discount removed from ${name}`);
        viewCustomer(id); // Refresh modal
        loadCustomers(); // Refresh list
      } catch (error) {
        alert('Error removing discount: ' + error.message);
      }
    }

    // Deny pending discount request
    async function denyDiscountRequest(id, name) {
      if (!confirm(`Deny discount request from "${name}"?\n\nThey will not receive a discount.`)) return;

      const reason = prompt('Enter reason for denial (optional):');

      try {
        const response = await fetch(`/api/customers/${id}/deny-discount-request`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert(`Discount request denied for ${name}`);
        viewCustomer(id); // Refresh modal
        loadCustomers(); // Refresh list
      } catch (error) {
        alert('Error denying discount request: ' + error.message);
      }
    }

    // Grant charity discount
    async function grantCharityDiscount(id, name) {
      const discountPercent = prompt(`Grant charity discount to "${name}".\n\nEnter discount percentage (default 50%):`, '50');
      if (discountPercent === null) return;

      const discount = parseInt(discountPercent) || 50;
      const reason = prompt('Enter reason for granting discount (optional):');

      if (!confirm(`Grant ${discount}% charity discount to ${name}?`)) return;

      try {
        const response = await fetch(`/api/customers/${id}/grant-charity-discount`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ discountPercent: discount, reason })
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert(`Charity discount of ${discount}% granted to ${name}`);
        viewCustomer(id); // Refresh modal
        loadCustomers(); // Refresh list
      } catch (error) {
        alert('Error granting discount: ' + error.message);
      }
    }

    // Revoke charity discount
    async function revokeCharityDiscount(id, name) {
      if (!confirm(`Revoke charity discount from "${name}"?\n\nThey will no longer receive discounted credit pricing.`)) return;

      const reason = prompt('Enter reason for revoking discount (optional):');

      try {
        const response = await fetch(`/api/customers/${id}/revoke-charity-discount`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert(`Charity discount revoked from ${name}`);
        viewCustomer(id); // Refresh modal
        loadCustomers(); // Refresh list
      } catch (error) {
        alert('Error revoking discount: ' + error.message);
      }
    }

    // Deny charity review
    async function denyCharityReview(id, name) {
      if (!confirm(`Deny charity status for "${name}"?\n\nThis will mark the review as completed without granting a discount.`)) return;

      const reason = prompt('Enter reason for denial (optional):');

      try {
        const response = await fetch(`/api/customers/${id}/deny-charity-review`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert(`Charity review denied for ${name}`);
        viewCustomer(id); // Refresh modal
        loadCustomers(); // Refresh list
      } catch (error) {
        alert('Error denying review: ' + error.message);
      }
    }

    // Email customer
    let currentCustomerEmail = null;

    async function emailCustomer(id, name) {
      // First fetch the customer email
      try {
        const response = await fetch(`/api/customers/${id}`);
        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        currentCustomerEmail = data.data.email;
        if (!currentCustomerEmail) {
          alert('No email address found for this customer');
          return;
        }

        document.getElementById('emailModalTitle').textContent = `Email: ${name}`;
        document.getElementById('emailTo').value = currentCustomerEmail;
        document.getElementById('emailSubject').value = '';
        document.getElementById('emailBody').value = '';
        document.getElementById('emailCustomerId').value = id;
        document.getElementById('emailModal').classList.add('active');
      } catch (error) {
        alert('Error loading customer email: ' + error.message);
      }
    }

    async function sendCustomerEmail() {
      const id = document.getElementById('emailCustomerId').value;
      const subject = document.getElementById('emailSubject').value.trim();
      const body = document.getElementById('emailBody').value.trim();

      if (!subject) {
        alert('Please enter a subject');
        return;
      }
      if (!body) {
        alert('Please enter a message');
        return;
      }

      try {
        const response = await fetch(`/api/communications/send-individual/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subject, body, emailType: 'individual' })
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        alert('Email sent successfully!');
        closeEmailModal();
      } catch (error) {
        alert('Error sending email: ' + error.message);
      }
    }

    function closeEmailModal() {
      document.getElementById('emailModal').classList.remove('active');
    }

    // Close modals
    function closeModal() {
      document.getElementById('customerModal').classList.remove('active');
    }

    function closeUsageModal() {
      document.getElementById('usageModal').classList.remove('active');
    }

    // Logout
    async function logout() {
      try {
        await fetch('/auth/logout', { method: 'POST' });
        window.location.href = '/login';
      } catch (error) {
        console.error('Logout error:', error);
      }
    }

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // Load customers on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadCustomers();

      // Auto-open modal if view parameter present (from redirect)
      const urlParams = new URLSearchParams(window.location.search);
      const viewId = urlParams.get('view');
      if (viewId) {
        viewCustomer(viewId);
        // Clean up URL without reloading
        window.history.replaceState({}, '', '/customers');
      }
    });
  </script>
</body>
</html>
